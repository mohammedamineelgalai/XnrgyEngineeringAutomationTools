<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XEAT Admin Console - Remote Control Center</title>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        /* =====================================================
           XNRGY Engineering Automation Tools - Theme Colors
           ===================================================== */
        :root {
            --xnrgy-bg-dark: #1a1a2e;
            --xnrgy-bg-panel: #252540;
            --xnrgy-bg-header: #2A4A6F;
            --xnrgy-bg-card: #252536;
            --xnrgy-bg-input: #1A3A5C;
            --xnrgy-cyan: #00d4ff;
            --xnrgy-cyan-glow: rgba(0, 212, 255, 0.3);
            --xnrgy-blue: #0078D4;
            --xnrgy-blue-hover: #1E90FF;
            --xnrgy-green: #00D26A;
            --xnrgy-green-hover: #00FF7F;
            --xnrgy-orange: #FF8C00;
            --xnrgy-red: #E81123;
            --xnrgy-red-hover: #FF4444;
            --xnrgy-purple: #7C4DFF;
            --xnrgy-border: #4A7FBF;
            --xnrgy-border-light: rgba(74, 127, 191, 0.3);
            --xnrgy-text: #FFFFFF;
            --xnrgy-text-secondary: #B0B0C0;
            --xnrgy-text-muted: #6B7A8F;
            --shadow-glow: 0 0 20px var(--xnrgy-cyan-glow);
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--xnrgy-bg-dark);
            color: var(--xnrgy-text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--xnrgy-bg-header);
            border-bottom: 2px solid var(--xnrgy-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .logo-text h1 {
            font-size: 1rem;
            font-weight: 600;
        }

        .logo-text span {
            font-size: 0.65rem;
            color: var(--xnrgy-cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.online {
            background: rgba(0, 210, 106, 0.15);
            color: var(--xnrgy-green);
            border: 1px solid rgba(0, 210, 106, 0.4);
        }

        .status-badge.offline {
            background: rgba(232, 17, 35, 0.15);
            color: var(--xnrgy-red);
            border: 1px solid rgba(232, 17, 35, 0.4);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 60px;
            left: 0;
            width: 220px;
            height: calc(100vh - 60px);
            background: var(--xnrgy-bg-card);
            border-right: 1px solid var(--xnrgy-border-light);
            padding: 15px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 20px;
        }

        .nav-section-title {
            padding: 0 15px;
            margin-bottom: 8px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--xnrgy-text-muted);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            color: var(--xnrgy-text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: var(--transition);
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(0, 212, 255, 0.1);
            color: var(--xnrgy-cyan);
        }

        .nav-item.active {
            background: rgba(0, 212, 255, 0.15);
            color: var(--xnrgy-cyan);
            border-left-color: var(--xnrgy-cyan);
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
        }

        .nav-badge {
            margin-left: auto;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .nav-badge.danger { background: var(--xnrgy-red); color: white; }
        .nav-badge.warning { background: var(--xnrgy-orange); color: white; }
        .nav-badge.success { background: var(--xnrgy-green); color: white; }

        /* Main Content */
        .main {
            margin-left: 220px;
            margin-top: 60px;
            padding: 20px;
            min-height: calc(100vh - 60px);
        }

        .page { display: none; }
        .page.active { display: block; }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .page-subtitle {
            color: var(--xnrgy-text-secondary);
            font-size: 0.85rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--xnrgy-bg-card);
            border: 1px solid var(--xnrgy-border-light);
            border-radius: 10px;
            padding: 15px;
            transition: var(--transition);
        }

        .stat-card:hover {
            border-color: var(--xnrgy-cyan);
            box-shadow: var(--shadow-glow);
        }

        .stat-card .label {
            font-size: 0.75rem;
            color: var(--xnrgy-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .stat-card .change {
            font-size: 0.75rem;
        }

        .stat-card .change.up { color: var(--xnrgy-green); }
        .stat-card .change.down { color: var(--xnrgy-red); }

        /* Cards */
        .card {
            background: var(--xnrgy-bg-card);
            border: 1px solid var(--xnrgy-border-light);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--xnrgy-bg-header);
            border-bottom: 1px solid var(--xnrgy-border-light);
        }

        .card-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: 15px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.8rem;
            color: var(--xnrgy-text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            background: var(--xnrgy-bg-input);
            border: 1px solid var(--xnrgy-border-light);
            border-radius: 6px;
            color: var(--xnrgy-text);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--xnrgy-cyan);
            box-shadow: 0 0 0 3px var(--xnrgy-cyan-glow);
        }

        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }

        select.form-control {
            cursor: pointer;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: var(--xnrgy-bg-panel);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .toggle-label {
            display: flex;
            flex-direction: column;
        }

        .toggle-label .title {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .toggle-label .desc {
            font-size: 0.75rem;
            color: var(--xnrgy-text-muted);
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #3a3a50;
            border-radius: 26px;
            transition: var(--transition);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle input:checked + .toggle-slider {
            background: var(--xnrgy-green);
        }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle.danger input:checked + .toggle-slider {
            background: var(--xnrgy-red);
        }

        .toggle.warning input:checked + .toggle-slider {
            background: var(--xnrgy-orange);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--xnrgy-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--xnrgy-blue-hover);
            box-shadow: 0 0 15px rgba(0, 120, 212, 0.4);
        }

        .btn-success {
            background: var(--xnrgy-green);
            color: white;
        }

        .btn-success:hover {
            background: var(--xnrgy-green-hover);
        }

        .btn-danger {
            background: var(--xnrgy-red);
            color: white;
        }

        .btn-danger:hover {
            background: var(--xnrgy-red-hover);
        }

        .btn-warning {
            background: var(--xnrgy-orange);
            color: white;
        }

        .btn-secondary {
            background: var(--xnrgy-bg-panel);
            color: var(--xnrgy-text);
            border: 1px solid var(--xnrgy-border-light);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.75rem;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--xnrgy-border-light);
        }

        th {
            background: var(--xnrgy-bg-header);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--xnrgy-text-secondary);
        }

        tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        
        /* Device Details Row - Ligne depliable */
        .device-details-row {
            background: #1a2332 !important;
        }
        .device-details-row:hover {
            background: #1a2332 !important;
        }
        .device-details-row td {
            padding: 0 !important;
            border-bottom: 2px solid var(--xnrgy-orange) !important;
        }
        
        /* Device Details Panel - Panneau depliable */
        .device-details-panel {
            background: #1a2332;
            border: 1px solid var(--xnrgy-border-light);
            border-left: 4px solid var(--xnrgy-orange);
            border-radius: 0 0 8px 8px;
            margin: -1px 0 15px 0;
            overflow: hidden;
        }
        
        /* User Details Panel - Panneau depliable */
        .user-details-panel {
            background: #1a2332;
            border: 1px solid var(--xnrgy-border-light);
            border-left: 4px solid var(--xnrgy-cyan);
            border-radius: 0 0 8px 8px;
            margin: -1px 0 15px 0;
            overflow: hidden;
        }

        .status-online { color: var(--xnrgy-green); }
        .status-offline { color: var(--xnrgy-text-muted); }
        .status-blocked { color: var(--xnrgy-red); }
        .status-uninstalled { color: #6c757d; font-style: italic; }
        .status-warning { color: var(--xnrgy-orange); }

        /* Alert Boxes */
        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-danger {
            background: rgba(232, 17, 35, 0.15);
            border: 1px solid rgba(232, 17, 35, 0.3);
            color: var(--xnrgy-red);
        }

        .alert-warning {
            background: rgba(255, 140, 0, 0.15);
            border: 1px solid rgba(255, 140, 0, 0.3);
            color: var(--xnrgy-orange);
        }

        .alert-success {
            background: rgba(0, 210, 106, 0.15);
            border: 1px solid rgba(0, 210, 106, 0.3);
            color: var(--xnrgy-green);
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        /* User/Device Cards */
        .item-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--xnrgy-bg-panel);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .item-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--xnrgy-bg-header);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--xnrgy-cyan);
        }

        .item-info {
            flex: 1;
        }

        .item-info .name {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .item-info .meta {
            font-size: 0.75rem;
            color: var(--xnrgy-text-muted);
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--xnrgy-bg-card);
            border-radius: 8px;
            border-left: 4px solid;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            min-width: 280px;
        }

        .toast.success { border-left-color: var(--xnrgy-green); }
        .toast.error { border-left-color: var(--xnrgy-red); }
        .toast.warning { border-left-color: var(--xnrgy-orange); }
        .toast.info { border-left-color: var(--xnrgy-blue); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 46, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--xnrgy-border-light);
            border-top-color: var(--xnrgy-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Quick Actions Panel */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            background: var(--xnrgy-bg-card);
            border: 1px solid var(--xnrgy-border-light);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-action-btn:hover {
            border-color: var(--xnrgy-cyan);
            background: rgba(0, 212, 255, 0.1);
        }

        .quick-action-btn svg {
            width: 28px;
            height: 28px;
        }

        .quick-action-btn span {
            font-size: 0.8rem;
            text-align: center;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--xnrgy-border-light);
        }

        .tab {
            padding: 10px 15px;
            background: transparent;
            border: none;
            color: var(--xnrgy-text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .tab:hover {
            color: var(--xnrgy-text);
        }

        .tab.active {
            color: var(--xnrgy-cyan);
            border-bottom-color: var(--xnrgy-cyan);
        }

        /* Search */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            background: var(--xnrgy-bg-input);
            border: 1px solid var(--xnrgy-border-light);
            border-radius: 6px;
            color: var(--xnrgy-text);
        }

        .search-box svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--xnrgy-text-muted);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 5px 12px;
            background: var(--xnrgy-bg-panel);
            border: 1px solid var(--xnrgy-border-light);
            border-radius: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-chip:hover, .filter-chip.active {
            background: var(--xnrgy-cyan);
            color: var(--xnrgy-bg-dark);
            border-color: var(--xnrgy-cyan);
        }

        /* Activity Feed */
        .activity-item {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--xnrgy-border-light);
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.login { background: rgba(0, 210, 106, 0.2); color: var(--xnrgy-green); }
        .activity-icon.logout { background: rgba(107, 122, 143, 0.2); color: var(--xnrgy-text-muted); }
        .activity-icon.error { background: rgba(232, 17, 35, 0.2); color: var(--xnrgy-red); }
        .activity-icon.warning { background: rgba(255, 140, 0, 0.2); color: var(--xnrgy-orange); }
        .activity-icon.info { background: rgba(0, 120, 212, 0.2); color: var(--xnrgy-blue); }

        .activity-content {
            flex: 1;
        }

        .activity-content .text {
            font-size: 0.85rem;
        }

        .activity-content .time {
            font-size: 0.7rem;
            color: var(--xnrgy-text-muted);
        }

        /* =====================================================
           RESPONSIVE MOBILE & TABLET STYLES
           ===================================================== */
        
        /* Tablette (768px - 1024px) */
        @media (max-width: 1024px) {
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            
            .sidebar {
                width: 70px;
            }
            
            .sidebar .nav-section-title,
            .sidebar .nav-item span,
            .sidebar .logo-text {
                display: none;
            }
            
            .sidebar .nav-item {
                justify-content: center;
                padding: 12px;
            }
            
            .sidebar .nav-item svg {
                margin-right: 0;
            }
            
            .main {
                margin-left: 70px;
            }
            
            .header {
                left: 70px;
            }
        }
        
        /* Mobile (max 768px) */
        @media (max-width: 768px) {
            /* Layout principal */
            .sidebar {
                position: fixed;
                left: -250px;
                width: 250px;
                z-index: 1001;
                transition: left 0.3s ease;
                height: 100vh;
                top: 0;
            }
            
            .sidebar.mobile-open {
                left: 0;
            }
            
            .sidebar .nav-section-title,
            .sidebar .nav-item span,
            .sidebar .logo-text {
                display: block;
            }
            
            .sidebar .nav-item {
                justify-content: flex-start;
                padding: 12px 16px;
            }
            
            .sidebar .nav-item svg {
                margin-right: 12px;
            }
            
            .main {
                margin-left: 0;
                padding: 70px 10px 10px 10px;
            }
            
            .header {
                left: 0;
                padding: 0 10px;
            }
            
            .header-left .logo-text {
                display: none;
            }
            
            /* Menu burger */
            .mobile-menu-btn {
                display: flex !important;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                background: var(--xnrgy-bg-panel);
                border: 1px solid var(--xnrgy-border-light);
                border-radius: 8px;
                cursor: pointer;
                margin-right: 10px;
            }
            
            .mobile-menu-btn svg {
                width: 24px;
                height: 24px;
                stroke: var(--xnrgy-cyan);
            }
            
            /* Overlay mobile */
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 1000;
            }
            
            .mobile-overlay.active {
                display: block;
            }
            
            /* Grids */
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            /* Cards */
            .card {
                padding: 12px;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .card-header h3 {
                font-size: 1rem;
            }
            
            /* Tables - scroll horizontal */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            table th, table td {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            /* Page header */
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .page-title {
                font-size: 1.3rem;
            }
            
            .page-subtitle {
                font-size: 0.8rem;
            }
            
            /* Buttons */
            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .btn-sm {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
            
            /* Stats */
            .stat-card {
                padding: 12px;
            }
            
            .stat-card .value {
                font-size: 1.5rem;
            }
            
            /* Search */
            .search-box {
                margin-bottom: 12px;
            }
            
            .search-box input {
                font-size: 0.9rem;
            }
            
            /* Filters */
            .filters {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .filter-chip {
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            
            /* Forms */
            .form-control {
                font-size: 0.9rem;
                padding: 10px;
            }
            
            .form-group label {
                font-size: 0.8rem;
            }
            
            /* Modal */
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 10px;
                max-height: 90vh;
            }
            
            .modal-header h3 {
                font-size: 1.1rem;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            /* Toast */
            .toast-container {
                right: 10px;
                left: 10px;
                top: 70px;
            }
            
            .toast {
                font-size: 0.85rem;
            }
            
            /* Device details panel - mobile */
            .device-details-panel > div > div {
                grid-template-columns: 1fr !important;
            }
            
            /* Header buttons */
            .header-right {
                gap: 5px;
            }
            
            .header-right .btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
            
            .header-right .btn span {
                display: none;
            }
            
            /* Header responsive mobile */
            .header {
                height: 55px;
                padding: 0 8px;
            }
            
            .header .logo img {
                width: 32px;
                height: 32px;
            }
            
            .header .logo-text h1 {
                font-size: 0.85rem;
            }
            
            .header .logo-text span {
                font-size: 0.55rem;
            }
            
            .status-badge {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
            
            .status-badge span {
                display: none;
            }
            
            .github-releases-btn {
                padding: 5px 8px !important;
            }
            
            .github-releases-btn span {
                display: none !important;
            }
        }
        
        /* Mobile petit √©cran (max 480px) */
        @media (max-width: 480px) {
            .main {
                padding: 55px 8px 8px 8px;
            }
            
            .header {
                height: 50px;
                padding: 0 5px;
            }
            
            .header .logo {
                gap: 6px;
            }
            
            .header .logo img {
                width: 28px;
                height: 28px;
            }
            
            .header .logo-text h1 {
                font-size: 0.75rem;
            }
            
            .header .logo-text span {
                display: none;
            }
            
            .header-right {
                gap: 4px;
            }
            
            .header-right .btn {
                padding: 5px 6px;
                font-size: 0.7rem;
            }
            
            .mobile-menu-btn {
                width: 34px;
                height: 34px;
                margin-right: 5px;
            }
            
            .mobile-menu-btn svg {
                width: 20px;
                height: 20px;
            }
            
            .status-badge {
                padding: 3px 6px;
                font-size: 0.65rem;
            }
            
            .status-badge .status-dot {
                width: 6px;
                height: 6px;
            }
            
            .github-releases-btn {
                padding: 4px 6px !important;
            }
            
            .github-releases-btn svg {
                width: 14px;
                height: 14px;
            }

            .stat-card {
                padding: 10px;
            }
            
            .stat-card .value {
                font-size: 1.3rem;
            }
            
            .stat-card .label {
                font-size: 0.7rem;
            }
            
            .card-header h3 {
                font-size: 0.9rem;
            }
            
            .page-title {
                font-size: 1.1rem;
            }
            
            /* Hide less important columns on very small screens */
            table .hide-mobile {
                display: none;
            }
            
            /* Quick actions - vertical stack */
            .item-actions {
                flex-direction: column;
                gap: 4px;
            }
            
            .item-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Desktop - cacher le bouton menu */
        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none !important;
            }
            
            .mobile-overlay {
                display: none !important;
            }
        }
        
        /* Print styles */
        @media print {
            .sidebar, .header, .mobile-menu-btn, .btn {
                display: none !important;
            }
            
            .main {
                margin: 0;
                padding: 0;
            }
            
            .card {
                break-inside: avoid;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>

    <!-- Header -->
    <header class="header">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="6" x2="21" y2="6"/>
                <line x1="3" y1="12" x2="21" y2="12"/>
                <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
        </button>
        <div class="logo">
            <img src="logo.png" alt="XEAT">
            <div class="logo-text">
                <h1>XEAT Admin Console</h1>
                <span>Remote Control Center</span>
            </div>
        </div>
        <div class="header-right">
            <a href="https://github.com/mohammedamineelgalai/XnrgyEngineeringAutomationTools/releases/latest" target="_blank" class="btn btn-sm github-releases-btn" style="background: linear-gradient(135deg, #238636 0%, #2ea043 100%); border: 1px solid #3fb950; display: flex; align-items: center; gap: 6px; text-decoration: none; color: #ffffff; font-weight: 600; box-shadow: 0 0 10px rgba(35, 134, 54, 0.3);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <span>Releases</span>
            </a>
            <div class="status-badge online" id="connectionStatus">
                <div class="status-dot"></div>
                <span id="connectionText">Connecte</span>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="refreshData()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6"/><path d="M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
            </button>
            <button class="btn btn-danger btn-sm" onclick="logout()">Deconnexion</button>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="nav-section">
            <div class="nav-section-title">Vue d'ensemble</div>
            <a class="nav-item active" onclick="showPage('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/>
                    <rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/>
                </svg>
                <span>Dashboard</span>
            </a>
            <a class="nav-item" onclick="showPage('activity')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
                <span>Activite</span>
                <span class="nav-badge success" id="activityBadge">0</span>
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Controle</div>
            <a class="nav-item" onclick="showPage('killswitch')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                </svg>
                <span>Kill Switch</span>
            </a>
            <a class="nav-item" onclick="showPage('maintenance')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                </svg>
                <span>Maintenance</span>
            </a>
            <a class="nav-item" onclick="showPage('updates')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <span>Mises a jour</span>
            </a>
            <a class="nav-item" onclick="showPage('features')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>Features</span>
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Gestion</div>
            <a class="nav-item" onclick="showPage('users')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <span>Utilisateurs</span>
                <span class="nav-badge success" id="usersBadge">0</span>
            </a>
            <a class="nav-item" onclick="showPage('devices')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                    <line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
                </svg>
                <span>Postes</span>
                <span class="nav-badge success" id="devicesBadge">0</span>
            </a>
            <a class="nav-item" onclick="showPage('sites')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span>Sites</span>
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Communication</div>
            <a class="nav-item" onclick="showPage('broadcasts')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9 22 2z"/>
                </svg>
                <span>Broadcasts</span>
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Monitoring</div>
            <a class="nav-item" onclick="showPage('telemetry')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                <span>Telemetrie</span>
            </a>
            <a class="nav-item" onclick="showPage('audit')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                </svg>
                <span>Audit Logs</span>
            </a>
            <a class="nav-item" onclick="showPage('security')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <span>Securite</span>
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Configuration</div>
            <a class="nav-item" onclick="showPage('settings')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                <span>Parametres</span>
            </a>
            <a class="nav-item" onclick="exportDatabase()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <span>Exporter</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <!-- Dashboard Page -->
        <div class="page active" id="page-dashboard">
            <div class="page-header">
                <div>
                    <h2 class="page-title">Dashboard</h2>
                    <p class="page-subtitle">Vue d'ensemble en temps reel</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary btn-sm" onclick="refreshData()">Actualiser</button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">Utilisateurs Total</div>
                    <div class="value" id="statTotalUsers">0</div>
                    <div class="change up">‚Üë Actifs: <span id="statActiveUsers">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="label">Postes Enregistres</div>
                    <div class="value" id="statTotalDevices">0</div>
                    <div class="change up">üü¢ En ligne: <span id="statOnlineDevices">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="label">Sessions Actives</div>
                    <div class="value" id="statActiveSessions">0</div>
                    <div class="change">Aujourd'hui</div>
                </div>
                <div class="stat-card">
                    <div class="label">Version Actuelle</div>
                    <div class="value" id="statCurrentVersion">-</div>
                    <div class="change">Deployee</div>
                </div>
            </div>

            <!-- Status Alerts -->
            <div id="statusAlerts"></div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h3>‚ö° Actions Rapides</h3>
                </div>
                <div class="card-body">
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="toggleKillSwitch()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--xnrgy-red)" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                            </svg>
                            <span>Kill Switch</span>
                        </div>
                        <div class="quick-action-btn" onclick="toggleMaintenance()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--xnrgy-orange)" stroke-width="2">
                                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                            </svg>
                            <span>Maintenance</span>
                        </div>
                        <div class="quick-action-btn" onclick="showPage('broadcasts')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--xnrgy-blue)" stroke-width="2">
                                <path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9 22 2z"/>
                            </svg>
                            <span>Broadcast</span>
                        </div>
                        <div class="quick-action-btn" onclick="showPage('updates')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--xnrgy-green)" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            <span>Publier MAJ</span>
                        </div>
                        <div class="quick-action-btn" onclick="forceLogoutAll()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="var(--xnrgy-purple)" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            <span>Deconnecter Tous</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Activity & Online Devices -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3>üìä Activite Recente</h3>
                    </div>
                    <div class="card-body" id="recentActivity">
                        <p style="color: var(--xnrgy-text-muted);">Aucune activite</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>üñ•Ô∏è Postes En Ligne</h3>
                    </div>
                    <div class="card-body" id="onlineDevicesList">
                        <p style="color: var(--xnrgy-text-muted);">Aucun poste en ligne</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kill Switch Page -->
        <div class="page" id="page-killswitch">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üö´ Kill Switch</h2>
                    <p class="page-subtitle">Desactiver l'application globalement ou par site/departement</p>
                </div>
            </div>

            <div class="alert alert-danger" id="killswitchWarning" style="display: none;">
                ‚ö†Ô∏è Le Kill Switch GLOBAL est ACTIF - Tous les utilisateurs sont bloques!
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>üåç Kill Switch Global</h3>
                </div>
                <div class="card-body">
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <span class="title">Desactiver TOUTE l'application</span>
                            <span class="desc">Bloque immediatement tous les utilisateurs (sauf admins si configure)</span>
                        </div>
                        <label class="toggle danger">
                            <input type="checkbox" id="killSwitchGlobal" onchange="updateKillSwitch('global', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Message affiche aux utilisateurs</label>
                        <textarea class="form-control" id="killSwitchMessage" placeholder="Application temporairement indisponible..."></textarea>
                    </div>
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <span class="title">Autoriser les administrateurs</span>
                            <span class="desc">Les admins peuvent toujours utiliser l'app</span>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="killSwitchAllowAdmins" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="btn btn-danger" onclick="applyKillSwitch()">Appliquer Kill Switch</button>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3>üìç Par Site</h3>
                    </div>
                    <div class="card-body" id="killSwitchBySite">
                        <!-- Dynamic content -->
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>üè¢ Par Departement</h3>
                    </div>
                    <div class="card-body" id="killSwitchByDept">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance Page -->
        <div class="page" id="page-maintenance">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üîß Mode Maintenance</h2>
                    <p class="page-subtitle">Planifier et activer la maintenance</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Activation Immediate</h3>
                </div>
                <div class="card-body">
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <span class="title">Mode Maintenance</span>
                            <span class="desc">Affiche un message de maintenance a tous les utilisateurs</span>
                        </div>
                        <label class="toggle warning">
                            <input type="checkbox" id="maintenanceToggle" onchange="updateMaintenance(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Message de maintenance</label>
                        <textarea class="form-control" id="maintenanceMessage" placeholder="L'application est en maintenance..."></textarea>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Heure de fin estimee</label>
                            <input type="datetime-local" class="form-control" id="maintenanceEndTime">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div class="toggle-container" style="margin: 0;">
                                <span>Afficher compte a rebours</span>
                                <label class="toggle">
                                    <input type="checkbox" id="maintenanceShowCountdown" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <span class="title">Mode lecture seule</span>
                            <span class="desc">Permet aux utilisateurs de consulter mais pas de modifier</span>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="maintenanceReadOnly">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="btn btn-warning" onclick="applyMaintenance()">Activer Maintenance</button>
                </div>
            </div>

            <!-- Message Templates Card -->
            <div class="card">
                <div class="card-header">
                    <h3>üìù Templates de Messages</h3>
                </div>
                <div class="card-body">
                    <p style="color: var(--xnrgy-text-secondary); margin-bottom: 15px;">
                        Cliquez sur un template pour l'utiliser comme message de maintenance
                    </p>
                    <div class="template-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">
                        <div class="template-btn" onclick="useMaintenanceTemplate('planned')" style="cursor: pointer; padding: 15px; border-radius: 8px; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">üìÖ</span>
                                <span style="font-weight: 600; color: var(--xnrgy-cyan);">Maintenance planifiee</span>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--xnrgy-text-secondary); margin: 0;">Maintenance reguliere avec previs</p>
                        </div>
                        <div class="template-btn" onclick="useMaintenanceTemplate('inProgress')" style="cursor: pointer; padding: 15px; border-radius: 8px; background: rgba(255, 140, 0, 0.1); border: 1px solid rgba(255, 140, 0, 0.3); transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">üîß</span>
                                <span style="font-weight: 600; color: var(--xnrgy-orange);">En cours</span>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--xnrgy-text-secondary); margin: 0;">Maintenance actuellement en cours</p>
                        </div>
                        <div class="template-btn" onclick="useMaintenanceTemplate('completed')" style="cursor: pointer; padding: 15px; border-radius: 8px; background: rgba(0, 210, 106, 0.1); border: 1px solid rgba(0, 210, 106, 0.3); transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">‚úÖ</span>
                                <span style="font-weight: 600; color: var(--xnrgy-green);">Terminee</span>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--xnrgy-text-secondary); margin: 0;">Notification de fin de maintenance</p>
                        </div>
                        <div class="template-btn" onclick="useMaintenanceTemplate('emergency')" style="cursor: pointer; padding: 15px; border-radius: 8px; background: rgba(232, 17, 35, 0.1); border: 1px solid rgba(232, 17, 35, 0.3); transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem;">üö®</span>
                                <span style="font-weight: 600; color: var(--xnrgy-red);">Urgente</span>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--xnrgy-text-secondary); margin: 0;">Intervention d'urgence non planifiee</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>üìÖ Maintenance Planifiee</h3>
                </div>
                <div class="card-body">
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <span class="title">Activer la planification</span>
                            <span class="desc">Maintenance automatique selon le planning</span>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="scheduledMaintenanceEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Date/Heure de debut</label>
                            <input type="datetime-local" class="form-control" id="scheduledStart">
                        </div>
                        <div class="form-group">
                            <label>Date/Heure de fin</label>
                            <input type="datetime-local" class="form-control" id="scheduledEnd">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notifier les utilisateurs (minutes avant)</label>
                        <select class="form-control" id="notifyBefore">
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="60">1 heure</option>
                            <option value="120">2 heures</option>
                            <option value="1440">1 jour</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="scheduleMaintenace()">Planifier</button>
                </div>
            </div>
        </div>

        <!-- Updates Page - Redesigned with GitHub Integration -->
        <div class="page" id="page-updates">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üì¶ Mises a Jour</h2>
                    <p class="page-subtitle">Gestion des versions et integration GitHub Releases</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <!-- GitHub Connection Status -->
                    <div id="githubStatus" class="status-badge" style="background: rgba(36, 41, 46, 0.8); border: 1px solid #30363d;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                        <span id="githubStatusText">Verification...</span>
                    </div>
                    <button class="btn btn-sm" onclick="fetchGitHubReleases()" style="background: #238636; border-color: #238636;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"/><path d="M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                        Sync GitHub
                    </button>
                </div>
            </div>

            <!-- Stats Cards - Enhanced Colors -->
            <div class="stats-grid">
                <div class="stat-card" style="border-left: 4px solid #00d4ff;">
                    <div class="label" style="color: #00d4ff;">VERSION DEPLOYEE</div>
                    <div class="value" id="deployedVersion" style="color: #00d4ff; font-size: 2.2rem;">1.0.0</div>
                    <div class="change up" id="deployedVersionDate" style="font-size: 0.7rem; color: #8b949e;">-</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #f0883e;">
                    <div class="label" style="color: #f0883e;">VERSION MINIMUM</div>
                    <div class="value" id="minimumVersion" style="color: #f0883e; font-size: 2.2rem;">1.0.0</div>
                    <div class="change" style="font-size: 0.7rem; color: #8b949e;">Requise pour utiliser l'app</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #3fb950;">
                    <div class="label" style="color: #3fb950;">UTILISATEURS A JOUR</div>
                    <div class="value" id="upToDateUsers" style="color: #3fb950; font-size: 2.2rem;">0%</div>
                    <div class="change up" id="upToDateCount" style="font-size: 0.7rem; color: #8b949e;">0 / 0 utilisateurs</div>
                </div>
            </div>

            <!-- GitHub Releases Card - NEW -->
            <div class="card" style="border: 1px solid #30363d;">
                <div class="card-header" style="background: linear-gradient(135deg, #161b22 0%, #0d1117 100%); border-bottom: 1px solid #30363d;">
                    <h3 style="color: #f0f6fc; display: flex; align-items: center; gap: 10px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#f0f6fc">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                        GitHub Releases
                    </h3>
                    <a href="https://github.com/mohammedamineelgalai/XnrgyEngineeringAutomationTools/releases" target="_blank" 
                       class="btn btn-sm" style="background: #238636; border-color: #238636; text-decoration: none; color: white;">
                        Voir sur GitHub
                    </a>
                </div>
                <div class="card-body" style="background: #0d1117; padding: 0;">
                    <div id="githubReleasesList" style="max-height: 300px; overflow-y: auto;">
                        <!-- GitHub releases will be loaded here -->
                        <div style="padding: 40px; text-align: center; color: #8b949e;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 15px; opacity: 0.5;">
                                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                            </svg>
                            <p>Cliquez sur "Sync GitHub" pour charger les releases</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Publish Update Card - Enhanced -->
            <div class="card" style="border: 1px solid rgba(0, 212, 255, 0.3);">
                <div class="card-header" style="background: linear-gradient(135deg, #1a3a5c 0%, #0d2137 100%);">
                    <h3 style="color: #00d4ff;">üöÄ Publier une Mise a Jour</h3>
                    <span style="font-size: 0.7rem; color: #8b949e; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 12px;">
                        Synchronise avec Firebase
                    </span>
                </div>
                <div class="card-body">
                    <div class="grid-2">
                        <div class="form-group">
                            <label style="color: #00d4ff; font-weight: 600;">Numero de version</label>
                            <input type="text" class="form-control" id="newVersion" placeholder="1.1.0" 
                                   style="border: 1px solid rgba(0, 212, 255, 0.3); font-size: 1.1rem;">
                        </div>
                        <div class="form-group">
                            <label style="color: #00d4ff; font-weight: 600;">URL de telechargement</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" class="form-control" id="downloadUrl" placeholder="https://github.com/.../releases/download/..." style="flex: 1;">
                                <button class="btn btn-sm" onclick="autoFillGitHubUrl()" style="background: #238636; white-space: nowrap;" title="Auto-remplir depuis GitHub">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                        <path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
                                        <path d="M16 21h5v-5"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="color: #00d4ff; font-weight: 600;">Notes de version</label>
                        <textarea class="form-control" id="releaseNotes" rows="4" placeholder="- Correction de bugs&#10;- Nouvelles fonctionnalites&#10;- Ameliorations performances"></textarea>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>SHA256 Checksum (optionnel)</label>
                            <input type="text" class="form-control" id="sha256" placeholder="abc123...">
                        </div>
                        <div class="form-group">
                            <label>Taille du fichier</label>
                            <input type="text" class="form-control" id="fileSize" placeholder="45 MB">
                        </div>
                    </div>
                    <div class="toggle-container" style="background: rgba(232, 17, 35, 0.1); border: 1px solid rgba(232, 17, 35, 0.3); border-radius: 8px; padding: 12px;">
                        <div class="toggle-label">
                            <span class="title" style="color: #ff6b6b;">‚ö†Ô∏è Mise a jour critique</span>
                            <span class="desc">Marquer comme mise a jour de securite obligatoire</span>
                        </div>
                        <label class="toggle danger">
                            <input type="checkbox" id="isCritical">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-success" onclick="publishUpdate()" style="flex: 1; padding: 12px; font-size: 1rem;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                <path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                            Publier la Mise a Jour
                        </button>
                        <button class="btn" onclick="previewUpdate()" style="background: #30363d; border-color: #30363d;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Force Update Card - Enhanced -->
            <div class="card" style="border: 1px solid rgba(240, 136, 62, 0.3);">
                <div class="card-header" style="background: linear-gradient(135deg, #5c3a1a 0%, #372110 100%);">
                    <h3 style="color: #f0883e;">‚ö†Ô∏è Forcer la Mise a Jour</h3>
                    <div id="forceUpdateStatus" style="font-size: 0.75rem; padding: 4px 12px; border-radius: 12px; background: rgba(0,0,0,0.3); color: #8b949e;">
                        Desactive
                    </div>
                </div>
                <div class="card-body">
                    <div class="toggle-container" style="background: rgba(240, 136, 62, 0.1); border: 1px solid rgba(240, 136, 62, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <div class="toggle-label">
                            <span class="title" style="color: #f0883e; font-size: 1rem;">üîí Activer Force Update</span>
                            <span class="desc">Oblige TOUS les utilisateurs a mettre a jour</span>
                        </div>
                        <label class="toggle warning">
                            <input type="checkbox" id="forceUpdateToggle" onchange="updateForceUpdatePreview()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="color: #f0883e; font-weight: 600;">Version minimum requise</label>
                        <input type="text" class="form-control" id="forceMinVersion" placeholder="1.0.0" 
                               style="border: 1px solid rgba(240, 136, 62, 0.3); font-size: 1.1rem;">
                    </div>
                    <div class="toggle-container" style="background: rgba(232, 17, 35, 0.1); border: 1px solid rgba(232, 17, 35, 0.3); border-radius: 8px; padding: 12px;">
                        <div class="toggle-label">
                            <span class="title" style="color: #ff6b6b;">üö´ Bloquer l'application</span>
                            <span class="desc">Empeche TOTALEMENT l'utilisation tant que non mis a jour</span>
                        </div>
                        <label class="toggle danger">
                            <input type="checkbox" id="blockUntilUpdated">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="btn btn-warning" onclick="applyForceUpdate()" style="width: 100%; margin-top: 15px; padding: 12px; font-size: 1rem;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Appliquer Force Update
                    </button>
                </div>
            </div>

            <!-- Update History Card - NEW -->
            <div class="card">
                <div class="card-header">
                    <h3>üìú Historique des Publications</h3>
                    <span style="font-size: 0.7rem; color: var(--xnrgy-text-muted);">Depuis Firebase</span>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="updateHistoryList" style="max-height: 250px; overflow-y: auto;">
                        <div style="padding: 30px; text-align: center; color: var(--xnrgy-text-muted);">
                            <p>Aucune publication enregistree</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Page -->
        <div class="page" id="page-features">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üéõÔ∏è Feature Flags</h2>
                    <p class="page-subtitle">Activer/desactiver les modules par role ou site</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Modules de l'Application</h3>
                </div>
                <div class="card-body" id="featureFlagsList">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Users Page -->
        <div class="page" id="page-users">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üë• Gestion des Utilisateurs</h2>
                    <p class="page-subtitle">Gerer les comptes et permissions</p>
                </div>
                <button class="btn btn-primary" onclick="showAddUserModal()">+ Ajouter</button>
            </div>

            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" id="userSearch" placeholder="Rechercher un utilisateur..." oninput="filterUsers()">
            </div>

            <div class="filters">
                <span class="filter-chip active" onclick="filterUsersByRole('all')">Tous</span>
                <span class="filter-chip" onclick="filterUsersByRole('admin')">Admins</span>
                <span class="filter-chip" onclick="filterUsersByRole('designer')">Designers</span>
                <span class="filter-chip" onclick="filterUsersByRole('user')">Users</span>
                <span class="filter-chip" onclick="filterUsersByStatus('blocked')">Bloques</span>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Role</th>
                                    <th>Site</th>
                                    <th>Statut</th>
                                    <th>Derniere connexion</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices Page -->
        <div class="page" id="page-devices">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üñ•Ô∏è Gestion des Postes</h2>
                    <p class="page-subtitle">Monitorer et controler les machines</p>
                </div>
                <button class="btn btn-primary" onclick="showAddDeviceModal()">+ Ajouter</button>
            </div>

            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" id="deviceSearch" placeholder="Rechercher un poste..." oninput="filterDevices()">
            </div>

            <div class="filters">
                <span class="filter-chip active" onclick="filterDevicesByStatus('all')">Tous</span>
                <span class="filter-chip" onclick="filterDevicesByStatus('online')">üü¢ En ligne</span>
                <span class="filter-chip" onclick="filterDevicesByStatus('offline')">‚ö´ Hors ligne</span>
                <span class="filter-chip" onclick="filterDevicesByStatus('blocked')">üî¥ Bloques</span>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Machine</th>
                                    <th>Site</th>
                                    <th>Utilisateur actuel</th>
                                    <th>Version XEAT</th>
                                    <th>Statut</th>
                                    <th>Dernier heartbeat</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="devicesTable">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sites Page -->
        <div class="page" id="page-sites">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üìç Gestion des Sites</h2>
                    <p class="page-subtitle">Configurer les sites XNRGY</p>
                </div>
            </div>

            <div class="grid-3" id="sitesGrid">
                <!-- Dynamic content -->
            </div>
        </div>

        <!-- Broadcasts Page -->
        <div class="page" id="page-broadcasts">
            <div class="page-header">
                <div>
                    <h2 class="page-title">Broadcasts</h2>
                    <p class="page-subtitle">Envoyer des messages aux utilisateurs</p>
                </div>
            </div>

            <!-- Messages de Bienvenue - Nouveau systeme multi-messages -->
            <div class="card" style="border: 1px solid rgba(0, 212, 255, 0.3);">
                <div class="card-header" style="background: linear-gradient(135deg, #1a3a5c 0%, #0d2137 100%);">
                    <h3 style="color: #00d4ff;">Messages de Bienvenue</h3>
                    <span class="badge" id="welcomeStatus" style="background: var(--xnrgy-green);">3 types configures</span>
                </div>
                <div class="card-body">
                    <p style="color: var(--xnrgy-text-secondary); margin-bottom: 20px;">
                        Configurez les messages de bienvenue pour differents scenarios. Chaque message peut etre affiche une seule fois par utilisateur.
                    </p>
                    
                    <!-- Type 1: Premier lancement apres installation -->
                    <div style="background: var(--xnrgy-bg-dark); border: 1px solid rgba(63, 185, 80, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">&#127881;</span>
                                <div>
                                    <span style="font-weight: 600; color: #3fb950;">Premier Lancement (Installation)</span>
                                    <p style="font-size: 0.75rem; color: var(--xnrgy-text-muted); margin: 0;">Affiche une seule fois apres l'installation pour chaque utilisateur</p>
                                </div>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="welcomeFirstInstallEnabled" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="grid-2" style="gap: 10px;">
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="font-size: 0.8rem;">Titre</label>
                                <input type="text" class="form-control" id="welcomeFirstInstallTitle" value="Bienvenue sur XEAT!">
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="font-size: 0.8rem;">Type</label>
                                <select class="form-control" id="welcomeFirstInstallType">
                                    <option value="info" selected>Info (Cyan)</option>
                                    <option value="success">Succes (Vert)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.8rem;">Message (utiliser \n pour les retours a la ligne)</label>
                            <textarea class="form-control" id="welcomeFirstInstallMessage" rows="4" style="font-size: 0.85rem;">Bienvenue dans XNRGY Engineering Automation Tools!\n\nXEAT est votre assistant d'ingenierie pour:\n\n[>] VAULT UPLOAD\n    Televersez vos fichiers Inventor vers Vault\n\n[>] COPY DESIGN\n    Copiez et renommez intelligemment vos assemblages\n\n[>] CONFIGURATION VAULT\n    Configurez facilement votre connexion Vault\n\nBonne utilisation!</textarea>
                        </div>
                    </div>

                    <!-- Type 2: Nouvel utilisateur sur poste existant -->
                    <div style="background: var(--xnrgy-bg-dark); border: 1px solid rgba(240, 136, 62, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">&#128100;</span>
                                <div>
                                    <span style="font-weight: 600; color: #f0883e;">Nouvel Utilisateur Windows</span>
                                    <p style="font-size: 0.75rem; color: var(--xnrgy-text-muted); margin: 0;">Affiche quand un autre utilisateur demarre l'app sur un poste deja installe</p>
                                </div>
                            </div>
                            <label class="toggle warning">
                                <input type="checkbox" id="welcomeNewUserEnabled" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="grid-2" style="gap: 10px;">
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="font-size: 0.8rem;">Titre</label>
                                <input type="text" class="form-control" id="welcomeNewUserTitle" value="Bienvenue!">
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="font-size: 0.8rem;">Type</label>
                                <select class="form-control" id="welcomeNewUserType">
                                    <option value="info" selected>Info (Cyan)</option>
                                    <option value="success">Succes (Vert)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.8rem;">Message</label>
                            <textarea class="form-control" id="welcomeNewUserMessage" rows="3" style="font-size: 0.85rem;">Bonjour et bienvenue dans XNRGY Engineering Automation Tools!\n\nCette application est deja installee sur ce poste.\n\nVotre session sera liee a votre compte Windows.\n\nPour toute question, contactez:\nmohammedamine.elgalai@xnrgy.com</textarea>
                        </div>
                    </div>

                    <!-- Type 3: Message Global (custom drop) -->
                    <div style="background: var(--xnrgy-bg-dark); border: 1px solid rgba(124, 77, 255, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">&#128227;</span>
                                <div>
                                    <span style="font-weight: 600; color: #7c4dff;">Message Global (Drop Custom)</span>
                                    <p style="font-size: 0.75rem; color: var(--xnrgy-text-muted); margin: 0;">Message personnalise pour tous les utilisateurs (vous pouvez l'activer a tout moment)</p>
                                </div>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="welcomeGlobalEnabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="grid-2" style="gap: 10px;">
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="font-size: 0.8rem;">Titre</label>
                                <input type="text" class="form-control" id="welcomeGlobalTitle" placeholder="Message Important">
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="font-size: 0.8rem;">Afficher une seule fois</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                                    <label class="toggle">
                                        <input type="checkbox" id="welcomeGlobalShowOnce" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="font-size: 0.75rem; color: var(--xnrgy-text-muted);">Si desactive, s'affiche a chaque demarrage</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.8rem;">Message</label>
                            <textarea class="form-control" id="welcomeGlobalMessage" rows="3" style="font-size: 0.85rem;" placeholder="Votre message personnalise pour tous les utilisateurs..."></textarea>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveWelcomeMessages()" style="flex: 1;">
                            Sauvegarder les Messages de Bienvenue
                        </button>
                        <button class="btn btn-secondary" onclick="loadWelcomeMessages()">
                            Recharger
                        </button>
                    </div>
                </div>
            </div>

            <!-- Legacy: Ancien Message de Bienvenue (pour compatibilite) -->
            <div class="card" style="opacity: 0.7;">
                <div class="card-header">
                    <h3>Message de Bienvenue (Legacy)</h3>
                    <span class="badge" style="background: var(--xnrgy-text-muted);">Ancien systeme</span>
                </div>
                <div class="card-body">
                    <p style="color: var(--xnrgy-text-muted); margin-bottom: 15px; font-size: 0.85rem;">
                        Ancien systeme de message unique. Utilisez le nouveau systeme ci-dessus pour plus de controle.
                    </p>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Titre du message</label>
                            <input type="text" class="form-control" id="welcomeTitle" placeholder="Bienvenue sur XEAT!">
                        </div>
                        <div class="form-group">
                            <label>Activer</label>
                            <div class="toggle-container" style="margin-top: 8px;">
                                <label class="toggle">
                                    <input type="checkbox" id="welcomeEnabled">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span style="margin-left: 10px;">Afficher au demarrage</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea class="form-control" id="welcomeMessage" rows="3" placeholder="Bienvenue dans XNRGY Engineering Automation Tools!"></textarea>
                    </div>
                    <button class="btn btn-secondary" onclick="saveWelcomeMessage()">Sauvegarder (Legacy)</button>
                </div>
            </div>

            <!-- Nouveau Broadcast avec Templates -->
            <div class="card">
                <div class="card-header">
                    <h3>Nouveau Message</h3>
                </div>
                <div class="card-body">
                    <!-- Templates pre-definis -->
                    <div class="form-group">
                        <label>üìã Template rapide</label>
                        <select class="form-control" id="broadcastTemplate" onchange="applyTemplate()">
                            <option value="">-- Selectionner un template --</option>
                            <optgroup label="üîß Maintenance">
                                <option value="maint_planned">Maintenance planifiee</option>
                                <option value="maint_urgent">Maintenance urgente</option>
                                <option value="maint_complete">Maintenance terminee</option>
                            </optgroup>
                            <optgroup label="üîÑ Mises a jour">
                                <option value="update_available">Nouvelle version disponible</option>
                                <option value="update_required">Mise a jour requise</option>
                                <option value="update_complete">Mise a jour terminee</option>
                            </optgroup>
                            <optgroup label="üì¢ Annonces">
                                <option value="announce_meeting">Reunion d'equipe</option>
                                <option value="announce_info">Information generale</option>
                                <option value="announce_reminder">Rappel important</option>
                            </optgroup>
                            <optgroup label="‚ö†Ô∏è Alertes">
                                <option value="alert_vault">Probleme Vault</option>
                                <option value="alert_network">Probleme reseau</option>
                                <option value="alert_urgent">Alerte urgente</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <hr style="border-color: var(--xnrgy-border-light); margin: 20px 0;">
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Type de message</label>
                            <select class="form-control" id="broadcastType">
                                <option value="info">‚ÑπÔ∏è Information</option>
                                <option value="warning">‚ö†Ô∏è Avertissement</option>
                                <option value="success">‚úÖ Succes</option>
                                <option value="error">‚ùå Erreur/Urgent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priorite</label>
                            <select class="form-control" id="broadcastPriority">
                                <option value="low">Basse</option>
                                <option value="normal" selected>Normale</option>
                                <option value="high">Haute</option>
                                <option value="critical">Critique</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Titre</label>
                        <input type="text" class="form-control" id="broadcastTitle" placeholder="Titre du message">
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea class="form-control" id="broadcastMessage" placeholder="Contenu du message..." rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Cible</label>
                        <select class="form-control" id="broadcastTarget">
                            <option value="all">Tous les utilisateurs</option>
                            <option value="site">Par site</option>
                            <option value="department">Par departement</option>
                            <option value="role">Par role</option>
                        </select>
                    </div>
                    <div class="grid-2">
                        <div class="toggle-container">
                            <span>Afficher comme popup</span>
                            <label class="toggle">
                                <input type="checkbox" id="broadcastPopup" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-container">
                            <span>Accus√© de reception requis</span>
                            <label class="toggle">
                                <input type="checkbox" id="broadcastAck">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="sendBroadcast()">üì§ Envoyer le Broadcast</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Messages Actifs</h3>
                    <button class="btn btn-secondary" onclick="refreshBroadcasts()" style="padding: 5px 10px; font-size: 0.8rem;">üîÑ Rafraichir</button>
                </div>
                <div class="card-body" id="activeBroadcasts">
                    <p style="color: var(--xnrgy-text-muted);">Aucun message actif</p>
                </div>
            </div>
        </div>

        <!-- Telemetry Page -->
        <div class="page" id="page-telemetry">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üìä Telemetrie</h2>
                    <p class="page-subtitle">Statistiques d'utilisation et performance</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">Sessions Totales</div>
                    <div class="value" id="teleTotalSessions">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Uploads Totaux</div>
                    <div class="value" id="teleTotalUploads">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Modules Crees</div>
                    <div class="value" id="teleTotalModules">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Erreurs</div>
                    <div class="value" id="teleTotalErrors">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Utilisation par Module</h3>
                </div>
                <div class="card-body" id="moduleUsage">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Audit Page -->
        <div class="page" id="page-audit">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üìã Audit Logs</h2>
                    <p class="page-subtitle">Historique des actions</p>
                </div>
                <button class="btn btn-secondary" onclick="exportAuditLogs()">Exporter</button>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date/Heure</th>
                                    <th>Action</th>
                                    <th>Utilisateur</th>
                                    <th>Details</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody id="auditTable">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Page -->
        <div class="page" id="page-security">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üîí Securite</h2>
                    <p class="page-subtitle">Parametres de securite et acces</p>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3>Parametres de Connexion</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Tentatives max avant blocage</label>
                            <input type="number" class="form-control" id="maxLoginAttempts" value="5">
                        </div>
                        <div class="form-group">
                            <label>Duree de blocage (minutes)</label>
                            <input type="number" class="form-control" id="lockoutDuration" value="30">
                        </div>
                        <div class="form-group">
                            <label>Timeout session (minutes)</label>
                            <input type="number" class="form-control" id="sessionTimeout" value="480">
                        </div>
                        <div class="form-group">
                            <label>Sessions max par utilisateur</label>
                            <input type="number" class="form-control" id="maxSessions" value="3">
                        </div>
                        <button class="btn btn-primary" onclick="saveSecuritySettings()">Sauvegarder</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Options</h3>
                    </div>
                    <div class="card-body">
                        <div class="toggle-container">
                            <div class="toggle-label">
                                <span class="title">Approbation des appareils</span>
                                <span class="desc">Nouveaux appareils doivent etre approuves</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="enforceDeviceApproval">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-container">
                            <div class="toggle-label">
                                <span class="title">Sessions multiples</span>
                                <span class="desc">Autoriser plusieurs sessions par utilisateur</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="allowMultipleSessions" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-container">
                            <div class="toggle-label">
                                <span class="title">Whitelist IP</span>
                                <span class="desc">Restreindre l'acces a certaines IPs</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="enableIpWhitelist">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="page-settings">
            <div class="page-header">
                <div>
                    <h2 class="page-title">‚öôÔ∏è Parametres</h2>
                    <p class="page-subtitle">Configuration generale de l'application</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Configuration Application</h3>
                </div>
                <div class="card-body">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Nom de l'application</label>
                            <input type="text" class="form-control" id="appName" value="XNRGY Engineering Automation Tools">
                        </div>
                        <div class="form-group">
                            <label>Nom court</label>
                            <input type="text" class="form-control" id="appShortName" value="XEAT">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Email support</label>
                            <input type="email" class="form-control" id="supportEmail">
                        </div>
                        <div class="form-group">
                            <label>Intervalle heartbeat (ms)</label>
                            <input type="number" class="form-control" id="heartbeatInterval" value="60000">
                        </div>
                    </div>
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <span class="title">Mode Debug</span>
                            <span class="desc">Activer les logs detailles</span>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="debugMode">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <span class="title">Telemetrie</span>
                            <span class="desc">Collecter les statistiques d'utilisation</span>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="enableTelemetry" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">Sauvegarder</button>
                </div>
            </div>
        </div>

        <!-- Activity Page -->
        <div class="page" id="page-activity">
            <div class="page-header">
                <div>
                    <h2 class="page-title">üìà Activite en Temps Reel</h2>
                    <p class="page-subtitle">Flux d'activite live</p>
                </div>
            </div>

            <div class="card">
                <div class="card-body" id="activityFeed">
                    <p style="color: var(--xnrgy-text-muted);">En attente d'activite...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Login Screen (Overlay) -->
    <div id="loginOverlay" style="position:fixed; top:0; left:0; right:0; bottom:0; background:var(--xnrgy-bg-dark); z-index:2000; display:flex; justify-content:center; align-items:center;">
        <div style="background:var(--xnrgy-bg-card); border-radius:16px; padding:40px; width:100%; max-width:400px; border:2px solid var(--xnrgy-border); box-shadow:0 0 40px var(--xnrgy-cyan-glow);">
            <div style="text-align:center; margin-bottom:30px;">
                <img src="logo.png" alt="XNRGY" style="width:80px; height:80px; border-radius:12px; margin-bottom:15px;">
                <h1 style="color:var(--xnrgy-cyan); margin:0; font-size:1.5rem;">XEAT Admin Console</h1>
                <p style="color:var(--xnrgy-text-muted); margin-top:5px; font-size:0.85rem;">Connexion Securisee Firebase</p>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div style="margin-bottom:15px;">
                    <label style="display:block; margin-bottom:8px; color:var(--xnrgy-text-secondary); font-size:0.9rem;">Email Admin</label>
                    <input type="email" id="loginEmail" placeholder="admin@xnrgy.com" 
                           style="width:100%; padding:12px 15px; border:1px solid var(--xnrgy-border); border-radius:8px; background:var(--xnrgy-bg-input); color:var(--xnrgy-text); font-size:1rem;"
                           autocomplete="email" required>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:var(--xnrgy-text-secondary); font-size:0.9rem;">Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="Mot de passe" 
                           style="width:100%; padding:12px 15px; border:1px solid var(--xnrgy-border); border-radius:8px; background:var(--xnrgy-bg-input); color:var(--xnrgy-text); font-size:1rem;"
                           autocomplete="current-password" required>
                </div>
                <div id="loginError" style="display:none; color:var(--xnrgy-red); background:rgba(232,17,35,0.1); padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.85rem;"></div>
                <button type="submit" id="loginBtn" style="width:100%; padding:14px; background:linear-gradient(135deg, var(--xnrgy-blue), var(--xnrgy-cyan)); border:none; border-radius:8px; color:white; font-size:1rem; font-weight:600; cursor:pointer; transition:all 0.3s;">
                    Se Connecter
                </button>
            </form>
            <div style="margin-top:20px; text-align:center;">
                <p style="color:var(--xnrgy-text-muted); font-size:0.75rem;">XNRGY Climate Systems ULC - 2026</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (CDN) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAiooksjw55ike9nQ4zB8oPPI_bjpaq2gQ",
            authDomain: "xeat-remote-control.firebaseapp.com",
            databaseURL: "https://xeat-remote-control-default-rtdb.firebaseio.com",
            projectId: "xeat-remote-control",
            storageBucket: "xeat-remote-control.firebasestorage.app",
            messagingSenderId: "407683391369",
            appId: "1:407683391369:web:f7bd4ea6551224bc6f4b58"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        const FIREBASE_URL = "https://xeat-remote-control-default-rtdb.firebaseio.com";
        
        let appData = {};
        let currentUser = null;
        let refreshInterval = null;
        let isAuthenticated = false;

        // ==================== FIREBASE AUTHENTICATION ====================
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');
            
            errorDiv.style.display = 'none';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Connexion en cours...';
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Verifier que l'utilisateur est admin
                const userSnapshot = await database.ref(`users/${currentUser.uid}/organization/role`).once('value');
                const role = userSnapshot.val();
                
                if (role === 'admin') {
                    isAuthenticated = true;
                    document.getElementById('loginOverlay').style.display = 'none';
                    setupFirebaseListeners();
                    showToast('Connexion reussie - Bienvenue Admin!', 'success');
                } else {
                    // Pas admin - deconnecter
                    await auth.signOut();
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = '[-] Acces refuse - Compte non administrateur';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.style.display = 'block';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorDiv.textContent = '[-] Utilisateur non trouve';
                        break;
                    case 'auth/wrong-password':
                        errorDiv.textContent = '[-] Mot de passe incorrect';
                        break;
                    case 'auth/invalid-email':
                        errorDiv.textContent = '[-] Email invalide';
                        break;
                    case 'auth/too-many-requests':
                        errorDiv.textContent = '[-] Trop de tentatives - Reessayez plus tard';
                        break;
                    default:
                        errorDiv.textContent = '[-] Erreur: ' + error.message;
                }
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Se Connecter';
            }
        }
        
        async function logout() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Logout error:', error);
            }
            isAuthenticated = false;
            currentUser = null;
            document.getElementById('loginOverlay').style.display = 'flex';
            showToast('Deconnexion reussie', 'info');
        }

        // ==================== MOBILE MENU ====================
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobileOverlay');
            const menuBtn = document.getElementById('mobileMenuBtn');
            
            if (sidebar.classList.contains('mobile-open')) {
                // Fermer le menu
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
                menuBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                `;
            } else {
                // Ouvrir le menu
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
                menuBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                `;
            }
        }
        
        // Fermer le menu mobile lors du clic sur un item de navigation
        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.sidebar .nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        toggleMobileMenu();
                    }
                });
            });
        });

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Observer l'etat d'authentification Firebase
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Utilisateur connecte - verifier le role admin
                    try {
                        const userSnapshot = await database.ref(`users/${user.uid}/organization/role`).once('value');
                        const role = userSnapshot.val();
                        
                        console.log('[+] Utilisateur connecte:', user.email, 'UID:', user.uid, 'Role:', role);
                        
                        if (role === 'admin') {
                            currentUser = user;
                            isAuthenticated = true;
                            document.getElementById('loginOverlay').style.display = 'none';
                            setupFirebaseListeners();
                            showToast('Session restauree - Bienvenue!', 'success');
                        } else {
                            // Pas admin - deconnecter
                            console.log('[-] Utilisateur non admin, deconnexion...');
                            await auth.signOut();
                            document.getElementById('loginError').style.display = 'block';
                            document.getElementById('loginError').textContent = '[-] Acces refuse - Compte non administrateur';
                        }
                    } catch (error) {
                        console.error('[-] Erreur verification role:', error);
                        // En cas d'erreur de lecture, on laisse passer (regles Firebase peuvent bloquer)
                        currentUser = user;
                        isAuthenticated = true;
                        document.getElementById('loginOverlay').style.display = 'none';
                        setupFirebaseListeners();
                    }
                } else {
                    // Pas connecte - afficher le login
                    console.log('[i] Aucun utilisateur connecte');
                    document.getElementById('loginOverlay').style.display = 'flex';
                }
                hideLoading();
            });
        });

        // ==================== REST API FUNCTIONS (Fallback) ====================
        let connectionErrorShown = false;
        
        async function loadDataFromFirebase() {
            try {
                const response = await fetch(`${FIREBASE_URL}/.json`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                appData = await response.json() || {};
                updateDashboard();
                setConnectionStatus(true);
                connectionErrorShown = false; // Reset error flag on success
            } catch (error) {
                console.error('Firebase REST error:', error);
                setConnectionStatus(false);
                // Only show toast once, not on every retry
                if (!connectionErrorShown) {
                    showToast('Erreur de connexion Firebase: ' + error.message, 'error');
                    connectionErrorShown = true;
                }
            }
        }

        async function writeToFirebase(path, data) {
            try {
                const response = await fetch(`${FIREBASE_URL}/${path}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                await loadDataFromFirebase(); // Refresh data
                return true;
            } catch (error) {
                console.error('Firebase write error:', error);
                showToast('Erreur d\'ecriture Firebase', 'error');
                return false;
            }
        }

        async function updateFirebaseValue(path, value) {
            return writeToFirebase(path, value);
        }

        async function deleteFromFirebase(path) {
            try {
                const response = await fetch(`${FIREBASE_URL}/${path}.json`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                await loadDataFromFirebase();
                return true;
            } catch (error) {
                console.error('Firebase delete error:', error);
                showToast('Erreur de suppression Firebase', 'error');
                return false;
            }
        }

        function setupFirebaseListeners() {
            console.log('[>] Configuration des listeners Firebase...');
            
            // Charger le message de bienvenue (legacy + nouveau systeme)
            loadWelcomeMessage();
            loadWelcomeMessages();
            
            // Charger les releases GitHub automatiquement
            fetchGitHubReleases();
            
            // Charger l'historique des mises a jour
            loadUpdateHistory();
            
            // Real-time listener using Firebase SDK
            database.ref('/').on('value', (snapshot) => {
                console.log('[+] Donnees Firebase recues');
                appData = snapshot.val() || {};
                console.log('[i] Devices:', Object.keys(appData.devices || {}).length);
                console.log('[i] Users:', Object.keys(appData.users || {}).length);
                updateDashboard();
                connectionErrorShown = false;
                setConnectionStatus(true);
            }, (error) => {
                console.error('[-] Firebase listener error:', error);
                console.error('[-] Code:', error.code);
                setConnectionStatus(false);
                showToast('Erreur Firebase: ' + error.message, 'error');
            });
        }

        // ==================== ONLINE STATUS DETECTION ====================
        // Timeout en millisecondes pour considerer un device hors ligne (3 minutes = 3x heartbeat interval)
        const HEARTBEAT_TIMEOUT_MS = 1 * 60 * 1000; // 1 minute - plus reactif

        /**
         * Determine si un device est reellement en ligne en verifiant le timestamp du heartbeat
         * Un device est considere hors ligne si:
         * - status.online est false, OU
         * - heartbeat.status est "offline", OU
         * - le dernier heartbeat date de plus de HEARTBEAT_TIMEOUT_MS
         */
        function isDeviceOnline(device) {
            if (!device) return false;
            
            // Si status.online est explicitement false, le device est offline
            if (device.status?.online === false) return false;
            
            // Si heartbeat.status est "offline", le device est offline
            if (device.heartbeat?.status === 'offline') return false;
            
            // Verifier le timestamp du dernier heartbeat
            const lastHeartbeat = device.heartbeat?.lastHeartbeat || device.status?.lastSeen;
            if (!lastHeartbeat || lastHeartbeat === 'none') return false;
            
            try {
                const lastHeartbeatTime = new Date(lastHeartbeat).getTime();
                const now = Date.now();
                const timeSinceLastHeartbeat = now - lastHeartbeatTime;
                
                // Si le dernier heartbeat est trop ancien, considerer hors ligne
                if (timeSinceLastHeartbeat > HEARTBEAT_TIMEOUT_MS) {
                    return false;
                }
                
                return true;
            } catch (error) {
                console.warn('[!] Erreur parsing heartbeat timestamp:', lastHeartbeat, error);
                return false;
            }
        }

        /**
         * Obtient le temps depuis le dernier heartbeat en format lisible
         */
        function getTimeSinceLastHeartbeat(device) {
            const lastHeartbeat = device?.heartbeat?.lastHeartbeat || device?.status?.lastSeen;
            if (!lastHeartbeat) return 'Jamais';
            
            try {
                const lastTime = new Date(lastHeartbeat).getTime();
                const now = Date.now();
                const diffMs = now - lastTime;
                
                if (diffMs < 60000) return 'Il y a moins d\'1 min';
                if (diffMs < 3600000) return `Il y a ${Math.floor(diffMs / 60000)} min`;
                if (diffMs < 86400000) return `Il y a ${Math.floor(diffMs / 3600000)} h`;
                return `Il y a ${Math.floor(diffMs / 86400000)} jour(s)`;
            } catch {
                return lastHeartbeat;
            }
        }

        // ==================== DASHBOARD ====================
        function updateDashboard() {
            // Stats
            const users = appData.users || {};
            const devices = appData.devices || {};
            const stats = appData.statistics?.global || {};

            const userCount = Object.keys(users).filter(k => k !== 'placeholder').length;
            
            // Compter les postes ACTIFS (app install√©e, pas d√©sinstall√©e)
            const activeDevices = Object.entries(devices).filter(([k, d]) => {
                if (k === 'templateDevice') return false;
                const xeatVersion = d?.software?.xeatVersion || '';
                const isEnabled = d?.status?.enabled !== false;
                const isInstalled = xeatVersion && xeatVersion !== 'uninstalled' && xeatVersion !== 'none' && xeatVersion !== '';
                return isInstalled && isEnabled;
            });
            const deviceCount = activeDevices.length;
            
            // Utiliser isDeviceOnline() pour verifier le heartbeat timeout
            const onlineDevices = activeDevices.filter(([k, d]) => isDeviceOnline(d));
            const onlineCount = onlineDevices.length;

            document.getElementById('statTotalUsers').textContent = userCount;
            document.getElementById('statActiveUsers').textContent = Object.values(users).filter(u => u?.status?.enabled !== false).length;
            document.getElementById('statTotalDevices').textContent = deviceCount;
            document.getElementById('statOnlineDevices').textContent = onlineCount;
            // Sessions actives = nombre de postes actuellement en ligne (pas le total historique)
            document.getElementById('statActiveSessions').textContent = onlineCount;
            document.getElementById('statCurrentVersion').textContent = appData.appConfig?.currentVersion || '1.0.0';

            // Badges
            document.getElementById('usersBadge').textContent = userCount;
            document.getElementById('devicesBadge').textContent = deviceCount;

            // Online Devices List
            updateOnlineDevicesList(onlineDevices);

            // Status Alerts
            updateStatusAlerts();

            // Update all pages
            updateUsersTable();
            updateDevicesTable();
            updateSitesGrid();
            updateFeatureFlags();
            updateBroadcastsList();
        }
        
        function updateOnlineDevicesList(onlineDevices) {
            const container = document.getElementById('onlineDevicesList');
            if (!container) return;
            
            if (onlineDevices.length === 0) {
                container.innerHTML = '<p style="color: var(--xnrgy-text-muted);">Aucun poste en ligne</p>';
                return;
            }
            
            let html = '';
            onlineDevices.forEach(([deviceId, device]) => {
                const machineName = device.registration?.machineName || device.system?.computerName || deviceId;
                const userName = device.status?.currentUser || 'Inconnu';
                const site = device.organization?.site || 'N/A';
                const lastSeen = device.status?.lastSeen || device.heartbeat?.lastHeartbeat || '-';
                const cpuUsage = device.heartbeat?.cpuUsage || 0;
                const ramUsage = device.heartbeat?.ramUsage || 0;
                
                html += `
                    <div class="activity-item">
                        <div class="activity-icon login">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 1a1 1 0 0 1 1 1v5.268l.854-.854a.5.5 0 1 1 .707.707l-1.414 1.414a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 1 1 .707-.707L8 7.268V2a1 1 0 0 1-1-1z"/>
                                <rect width="14" height="3" x="1" y="12" rx="1"/>
                            </svg>
                        </div>
                        <div class="activity-content">
                            <div class="text"><strong>${machineName}</strong> - ${userName}</div>
                            <div class="time">${site} | CPU: ${cpuUsage}% | RAM: ${ramUsage}%</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateStatusAlerts() {
            const alerts = [];
            
            if (appData.killSwitch?.global?.enabled) {
                alerts.push({ type: 'danger', text: 'üö´ KILL SWITCH GLOBAL ACTIF - Application bloquee!' });
                document.getElementById('killswitchWarning').style.display = 'flex';
                document.getElementById('killSwitchGlobal').checked = true;
            } else {
                document.getElementById('killswitchWarning').style.display = 'none';
                document.getElementById('killSwitchGlobal').checked = false;
            }

            if (appData.maintenance?.enabled) {
                alerts.push({ type: 'warning', text: 'üîß MODE MAINTENANCE ACTIF' });
                document.getElementById('maintenanceToggle').checked = true;
            } else {
                document.getElementById('maintenanceToggle').checked = false;
            }

            if (appData.forceUpdate?.enabled) {
                alerts.push({ type: 'warning', text: '‚ö†Ô∏è MISE A JOUR FORCEE ACTIVE - Version min: ' + appData.forceUpdate.minimumVersion });
            }

            const container = document.getElementById('statusAlerts');
            container.innerHTML = alerts.map(a => `<div class="alert alert-${a.type}">${a.text}</div>`).join('');
        }

        // ==================== USERS ====================
        function updateUsersTable() {
            const users = appData.users || {};
            const tbody = document.getElementById('usersTable');
            
            let html = '';
            Object.entries(users).forEach(([uid, user]) => {
                if (uid === 'placeholder') return;
                
                const profile = user.profile || user;
                const status = user.status || {};
                const org = user.organization || {};
                
                const isEnabled = status.enabled !== false;
                const isBlocked = status.blocked === true;
                const statusClass = isBlocked ? 'status-blocked' : (isEnabled ? 'status-online' : 'status-offline');
                const statusText = isBlocked ? 'üö´ Bloqu√©' : (isEnabled ? '‚úÖ Actif' : '‚è∏Ô∏è Inactif');
                
                const lastLogin = user.sessions?.lastLogin || profile.lastLogin || '-';
                
                html += `
                    <tr id="user-row-${uid}">
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="item-avatar">${(profile.fullName || profile.username || 'U')[0].toUpperCase()}</div>
                                <div>
                                    <div style="font-weight: 500;">${profile.fullName || profile.username || uid}</div>
                                    <div style="font-size: 0.75rem; color: var(--xnrgy-text-muted);">${profile.email || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td><span style="color: ${getRoleColor(org.role || profile.role)}">${getRoleIcon(org.role || profile.role)} ${org.role || profile.role || 'user'}</span></td>
                        <td>üìç ${org.site || profile.site || '-'}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>üïê ${formatDate(lastLogin)}</td>
                        <td>
                            <div class="btn-group">
                                ${isBlocked 
                                    ? `<button class="btn btn-success btn-sm" onclick="unblockUser('${uid}')">‚úÖ D√©bloquer</button>`
                                    : `<button class="btn btn-warning btn-sm" onclick="blockUser('${uid}')">üö´ Bloquer</button>`
                                }
                                <button class="btn btn-secondary btn-sm" id="btn-details-user-${uid}" onclick="toggleUserDetails('${uid}')">üìã Details</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            // Ajouter le HTML principal au tbody
            tbody.innerHTML = html || '<tr><td colspan="6" style="text-align: center; color: var(--xnrgy-text-muted);">Aucun utilisateur</td></tr>';
            
            // Cr√©er les conteneurs de d√©tails APR√àS le tableau
            let detailsContainer = document.getElementById('userDetailsContainer');
            if (!detailsContainer) {
                detailsContainer = document.createElement('div');
                detailsContainer.id = 'userDetailsContainer';
                tbody.parentElement.parentElement.appendChild(detailsContainer);
            }
            detailsContainer.innerHTML = '';
            
            Object.keys(users).forEach(uid => {
                if (uid === 'placeholder') return;
                const detailDiv = document.createElement('div');
                detailDiv.id = `user-details-${uid}`;
                detailDiv.className = 'user-details-panel';
                detailDiv.style.display = 'none';
                detailDiv.innerHTML = `<div id="user-details-content-${uid}" style="padding: 20px;"><p style="color: #888;">‚è≥ Chargement...</p></div>`;
                detailsContainer.appendChild(detailDiv);
            });
        }
        
        function getRoleIcon(role) {
            const icons = {
                'admin': 'üëë',
                'manager': 'üìä',
                'engineer': 'üîß',
                'technician': 'üõ†Ô∏è',
                'user': 'üë§',
                'viewer': 'üëÅÔ∏è'
            };
            return icons[role] || 'üë§';
        }

        // ==================== DEVICES ====================
        function updateDevicesTable() {
            const devices = appData.devices || {};
            const tbody = document.getElementById('devicesTable');
            
            let html = '';
            Object.entries(devices).forEach(([id, device]) => {
                if (id === 'templateDevice') return;
                
                const reg = device.registration || device;
                const status = device.status || device;
                const software = device.software || device;
                const heartbeat = device.heartbeat || {};
                
                // Verifier si l'app est installee (pas desinstallee)
                const xeatVersion = software.xeatVersion || device.appVersion || '';
                const isUninstalled = xeatVersion === 'uninstalled' || xeatVersion === 'none' || xeatVersion === '';
                
                // Utiliser isDeviceOnline() pour verifier le heartbeat timeout
                const isOnline = isDeviceOnline(device);
                const isBlocked = status.blocked === true;
                
                // Statut: Desinstalle > Bloque > En ligne/Hors ligne
                let statusClass, statusText, lastSeenInfo = '';
                if (isUninstalled) {
                    statusClass = 'status-uninstalled';
                    statusText = '‚ùå D√©sinstall√©';
                } else if (isBlocked) {
                    statusClass = 'status-blocked';
                    statusText = 'üö´ Bloqu√©';
                } else if (isOnline) {
                    statusClass = 'status-online';
                    statusText = 'üü¢ En ligne';
                } else {
                    statusClass = 'status-offline';
                    statusText = '‚ö´ Hors ligne';
                    lastSeenInfo = ` (${getTimeSinceLastHeartbeat(device)})`;
                }
                
                // Style grise pour les postes desinstalles
                const rowStyle = isUninstalled ? 'opacity: 0.5;' : '';
                const versionDisplay = isUninstalled ? '<span style="color: #dc3545; font-style: italic;">D√©sinstall√©</span>' : (xeatVersion || '-');
                
                html += `
                    <tr id="device-row-${id}" style="${rowStyle}">
                        <td>
                            <div style="font-weight: 500;">üíª ${reg.machineName || id}</div>
                            <div style="font-size: 0.75rem; color: var(--xnrgy-text-muted);">${device.organization?.assetTag ? 'üè∑Ô∏è ' + device.organization.assetTag : ''}</div>
                        </td>
                        <td>üìç ${device.organization?.site || status.site || '-'}</td>
                        <td>üë§ ${status.currentUser || '-'}</td>
                        <td>üì¶ ${versionDisplay}</td>
                        <td><span class="${statusClass}">${statusText}${lastSeenInfo}</span></td>
                        <td>üïê ${formatDate(heartbeat.lastHeartbeat || status.lastSeen)}</td>
                        <td>
                            <div class="btn-group">
                                ${isUninstalled 
                                    ? `<button class="btn btn-secondary btn-sm" disabled>Non disponible</button>`
                                    : isBlocked 
                                        ? `<button class="btn btn-success btn-sm" onclick="unblockDevice('${id}')">‚úÖ D√©bloquer</button>`
                                        : `<button class="btn btn-warning btn-sm" onclick="blockDevice('${id}')">üö´ Bloquer</button>`
                                }
                                <button class="btn btn-secondary btn-sm" id="btn-details-${id}" onclick="toggleDeviceDetails('${id}')">üìã Details</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            // Ajouter le HTML principal au tbody
            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align: center; color: var(--xnrgy-text-muted);">Aucun poste</td></tr>';
            
            // Creer les conteneurs de details APRES le tableau
            let detailsContainer = document.getElementById('deviceDetailsContainer');
            if (!detailsContainer) {
                detailsContainer = document.createElement('div');
                detailsContainer.id = 'deviceDetailsContainer';
                tbody.parentElement.parentElement.appendChild(detailsContainer);
            }
            detailsContainer.innerHTML = '';
            
            Object.keys(devices).forEach(id => {
                if (id === 'templateDevice') return;
                const detailDiv = document.createElement('div');
                detailDiv.id = `device-details-${id}`;
                detailDiv.className = 'device-details-panel';
                detailDiv.style.display = 'none';
                detailDiv.innerHTML = `<div id="device-details-content-${id}" style="padding: 20px;"><p style="color: #888;">Chargement...</p></div>`;
                detailsContainer.appendChild(detailDiv);
            });
        }

        // ==================== SITES ====================
        function updateSitesGrid() {
            const sites = appData.sites || {};
            const devices = appData.devices || {};
            const users = appData.users || {};
            const container = document.getElementById('sitesGrid');
            
            // Calculer les stats en temps r√©el par site (postes ACTIFS uniquement)
            const siteStats = {};
            Object.keys(sites).forEach(siteId => {
                siteStats[siteId] = { devices: 0, activeDevices: 0, users: 0 };
            });
            
            // Compter les postes par site - UNIQUEMENT ceux avec l'app install√©e (pas "uninstalled")
            Object.values(devices).forEach(device => {
                const siteId = device.organization?.site || 'unknown';
                const xeatVersion = device.software?.xeatVersion || '';
                const isEnabled = device.status?.enabled !== false;
                const isInstalled = xeatVersion && xeatVersion !== 'uninstalled' && xeatVersion !== 'none' && xeatVersion !== '';
                
                if (siteStats[siteId]) {
                    // Compter uniquement si l'app est install√©e (pas d√©sinstall√©e)
                    if (isInstalled && isEnabled) {
                        siteStats[siteId].activeDevices++;
                    }
                    siteStats[siteId].devices++; // Total historique
                }
            });
            
            // Compter les utilisateurs par site
            Object.values(users).forEach(user => {
                const siteId = user.profile?.site || user.organization?.site || 'unknown';
                if (siteStats[siteId]) {
                    siteStats[siteId].users++;
                }
            });
            
            let html = '';
            Object.entries(sites).forEach(([id, site]) => {
                const stats = siteStats[id] || { devices: 0, activeDevices: 0, users: 0 };
                html += `
                    <div class="card">
                        <div class="card-header">
                            <h3>üìç ${site.name}</h3>
                            <label class="toggle">
                                <input type="checkbox" ${site.enabled ? 'checked' : ''} onchange="toggleSite('${id}', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--xnrgy-text-muted); margin-bottom: 15px;">${site.fullName || site.name}</p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="stat-card" style="padding: 10px;">
                                    <div class="label">Utilisateurs</div>
                                    <div class="value" style="font-size: 1.2rem;">${stats.users}</div>
                                </div>
                                <div class="stat-card" style="padding: 10px;">
                                    <div class="label">Postes Actifs</div>
                                    <div class="value" style="font-size: 1.2rem; color: var(--xnrgy-green);">${stats.activeDevices}</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; font-size: 0.85rem; line-height: 1.6;">
                                ${site.address && site.address !== 'none' ? `<p style="margin: 5px 0;">üìç <strong>Adresse:</strong> ${site.address}</p>` : ''}
                                ${site.contactPhone && site.contactPhone !== 'none' ? `<p style="margin: 5px 0;">üìû <strong>Tel:</strong> <a href="tel:${site.contactPhone}" style="color: var(--xnrgy-green);">${site.contactPhone}</a></p>` : ''}
                                ${site.contactEmail && site.contactEmail !== 'none' ? `<p style="margin: 5px 0;">üìß <strong>Email:</strong> <a href="mailto:${site.contactEmail}" style="color: var(--xnrgy-green);">${site.contactEmail}</a></p>` : ''}
                                <p style="margin: 5px 0;"><strong>Pays:</strong> ${site.country} | <strong>Ville:</strong> ${site.city}</p>
                                <p style="margin: 5px 0;"><strong>Timezone:</strong> ${site.timezone?.replace('-', '/')}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ==================== FEATURE FLAGS ====================
        function updateFeatureFlags() {
            const features = appData.featureFlags || {};
            const container = document.getElementById('featureFlagsList');
            
            const featureNames = {
                vaultUploadModule: 'Vault Upload',
                copyDesignModule: 'Copy Design / Creer Module',
                vaultSettingsModule: 'Vault Settings (Admin)',
                smartToolsModule: 'Smart Tools',
                checklistHVAC: 'Checklist HVAC',
                telemetryCollection: 'Collecte Telemetrie',
                autoUpdate: 'Mise a jour automatique',
                darkTheme: 'Theme sombre'
            };
            
            let html = '';
            Object.entries(features).forEach(([id, feature]) => {
                // enabledForRoles peut etre une string "admin-designer-user" ou un array
                const roles = Array.isArray(feature.enabledForRoles) 
                    ? feature.enabledForRoles.join(', ') 
                    : (feature.enabledForRoles || 'all').replace(/-/g, ', ');
                
                html += `
                    <div class="toggle-container">
                        <div class="toggle-label">
                            <span class="title">${featureNames[id] || id}</span>
                            <span class="desc">Roles: ${roles}</span>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" ${feature.enabled ? 'checked' : ''} onchange="toggleFeature('${id}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p style="color: var(--xnrgy-text-muted);">Aucun feature flag configure</p>';
        }

        // ==================== BROADCASTS LIST ====================
        function updateBroadcastsList() {
            const broadcasts = appData.broadcasts || {};
            const container = document.getElementById('activeBroadcasts');
            if (!container) return;
            
            // Filtrer les broadcasts actifs (exclure placeholder)
            const activeBroadcasts = Object.entries(broadcasts)
                .filter(([id, b]) => id !== 'placeholder' && b?.status?.active === true)
                .sort((a, b) => {
                    // Trier par date (plus recent en premier)
                    const dateA = a[1]?.status?.sentAt || '';
                    const dateB = b[1]?.status?.sentAt || '';
                    return dateB.localeCompare(dateA);
                });
            
            if (activeBroadcasts.length === 0) {
                container.innerHTML = '<p style="color: var(--xnrgy-text-muted);">Aucun message actif</p>';
                return;
            }
            
            const typeIcons = {
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è',
                success: '‚úÖ',
                error: '‚ùå'
            };
            
            const typeColors = {
                info: 'var(--xnrgy-blue)',
                warning: 'var(--xnrgy-orange)',
                success: 'var(--xnrgy-green)',
                error: 'var(--xnrgy-red)'
            };
            
            let html = '<div style="display:flex; flex-direction:column; gap:12px;">';
            
            activeBroadcasts.forEach(([id, broadcast]) => {
                const type = broadcast.type || 'info';
                const icon = typeIcons[type] || '‚ÑπÔ∏è';
                const color = typeColors[type] || 'var(--xnrgy-blue)';
                const sentAt = broadcast.status?.sentAt ? formatDate(broadcast.status.sentAt) : 'Date inconnue';
                const viewCount = broadcast.status?.viewCount || 0;
                const showPopup = broadcast.display?.showAsPopup ? 'üîî' : '';
                const showBanner = broadcast.display?.showAsBanner ? 'üì¢' : '';
                
                html += `
                    <div style="background:var(--xnrgy-bg-panel); border-radius:8px; padding:15px; border-left:4px solid ${color};">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                            <div>
                                <span style="font-size:1.1rem; font-weight:600;">${icon} ${broadcast.title || 'Sans titre'}</span>
                                <span style="margin-left:10px; color:var(--xnrgy-text-muted); font-size:0.8rem;">${showPopup} ${showBanner}</span>
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn btn-sm btn-secondary" onclick="deactivateBroadcast('${id}')" title="Desactiver">
                                    ‚è∏Ô∏è Desactiver
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteBroadcast('${id}')" title="Supprimer">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                        </div>
                        <p style="color:var(--xnrgy-text-secondary); margin-bottom:8px;">${broadcast.message || ''}</p>
                        <div style="display:flex; gap:20px; font-size:0.8rem; color:var(--xnrgy-text-muted);">
                            <span>üìÖ ${sentAt}</span>
                            <span>üëÅÔ∏è ${viewCount} vues</span>
                            <span>üéØ ${broadcast.target?.type || 'all'}</span>
                            <span>üìä Priorite: ${broadcast.priority || 'normal'}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function deactivateBroadcast(id) {
            if (!confirm('Desactiver ce message?')) return;
            
            database.ref(`broadcasts/${id}/status/active`).set(false)
                .then(() => {
                    // Mettre a jour la copie locale
                    if (appData.broadcasts && appData.broadcasts[id]) {
                        appData.broadcasts[id].status = appData.broadcasts[id].status || {};
                        appData.broadcasts[id].status.active = false;
                    }
                    updateBroadcastsList();
                    showToast('Message desactive', 'success');
                    logAudit('broadcast_deactivated', id);
                })
                .catch(err => showToast('Erreur: ' + err.message, 'error'));
        }
        
        function deleteBroadcast(id) {
            if (!confirm('[!] Supprimer definitivement ce message?\n\nCette action est irreversible.')) return;
            
            database.ref(`broadcasts/${id}`).remove()
                .then(() => {
                    // Supprimer aussi de la copie locale
                    if (appData.broadcasts && appData.broadcasts[id]) {
                        delete appData.broadcasts[id];
                    }
                    updateBroadcastsList();
                    showToast('Message supprime', 'success');
                    logAudit('broadcast_deleted', id);
                })
                .catch(err => showToast('Erreur: ' + err.message, 'error'));
        }

        // ==================== ACTIONS ====================
        function toggleKillSwitch() {
            const current = appData.killSwitch?.global?.enabled || false;
            if (!current && !confirm('‚ö†Ô∏è ATTENTION: Activer le Kill Switch bloquera TOUS les utilisateurs!\n\nContinuer?')) return;
            
            database.ref('killSwitch/global/enabled').set(!current)
                .then(() => showToast(!current ? 'Kill Switch ACTIVE!' : 'Kill Switch desactive', !current ? 'warning' : 'success'))
                .catch(err => showToast('Erreur: ' + err.message, 'error'));
        }

        function updateKillSwitch(scope, enabled) {
            if (enabled && !confirm('‚ö†Ô∏è Activer le Kill Switch?')) {
                document.getElementById('killSwitchGlobal').checked = false;
                return;
            }
            database.ref(`killSwitch/${scope}/enabled`).set(enabled);
        }

        function applyKillSwitch() {
            const enabled = document.getElementById('killSwitchGlobal').checked;
            const message = document.getElementById('killSwitchMessage').value;
            const allowAdmins = document.getElementById('killSwitchAllowAdmins').checked;
            
            database.ref('killSwitch/global').update({
                enabled: enabled,
                message: message,
                allowAdmins: allowAdmins,
                activatedAt: enabled ? new Date().toISOString() : '',
                activatedBy: 'Admin Panel'
            }).then(() => {
                showToast(enabled ? 'Kill Switch applique!' : 'Kill Switch desactive', enabled ? 'warning' : 'success');
                logAudit('killswitch_toggle', enabled ? 'activated' : 'deactivated');
            });
        }

        function toggleMaintenance() {
            const current = appData.maintenance?.enabled || false;
            database.ref('maintenance/enabled').set(!current)
                .then(() => showToast(!current ? 'Maintenance activee' : 'Maintenance desactivee', 'info'));
        }

        function updateMaintenance(enabled) {
            database.ref('maintenance/enabled').set(enabled);
        }

        function applyMaintenance() {
            const enabled = document.getElementById('maintenanceToggle').checked;
            const message = document.getElementById('maintenanceMessage').value;
            const endTime = document.getElementById('maintenanceEndTime').value;
            const showCountdown = document.getElementById('maintenanceShowCountdown').checked;
            const readOnly = document.getElementById('maintenanceReadOnly').checked;
            
            database.ref('maintenance').update({
                enabled: enabled,
                message: message,
                estimatedEndTime: endTime,
                showCountdown: showCountdown,
                allowReadOnly: readOnly,
                startTime: enabled ? new Date().toISOString() : ''
            }).then(() => {
                showToast('Configuration maintenance appliquee', 'success');
                logAudit('maintenance_toggle', enabled ? 'activated' : 'deactivated');
            });
        }

        // Maintenance Templates
        const maintenanceTemplates = {
            planned: {
                title: "üìÖ Maintenance Planifi√©e",
                message: "Bonjour,\n\nüìÖ Une maintenance est planifi√©e.\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìÜ Heure estim√©e de fin: {endTime}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüíæ Veuillez sauvegarder votre travail avant le d√©but de la maintenance.\n\nMerci de votre compr√©hension.\n\n‚Äî √âquipe IT XNRGY"
            },
            inProgress: {
                title: "üîß Maintenance en Cours",
                message: "Bonjour,\n\nüîß Une maintenance est actuellement en cours.\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚è∞ Heure de fin estim√©e: {endTime}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n‚ö†Ô∏è L'application n'est temporairement pas disponible.\n\nNous vous remercions de votre patience.\n\n‚Äî √âquipe IT XNRGY"
            },
            completed: {
                title: "‚úÖ Maintenance Termin√©e",
                message: "Bonjour! üëã\n\n‚úÖ La maintenance est termin√©e avec succ√®s!\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüöÄ L'application est de nouveau disponible\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nMerci de votre patience.\nBon travail!\n\n‚Äî √âquipe IT XNRGY"
            },
            emergency: {
                title: "üö® Maintenance d'Urgence",
                message: "Bonjour,\n\nüö® Une intervention d'urgence est en cours.\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚ö†Ô∏è ATTENTION\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nUne maintenance non planifi√©e est n√©cessaire pour r√©soudre un probl√®me critique.\n\nNous travaillons activement √† r√©tablir le service.\nMerci de votre compr√©hension.\n\n‚Äî √âquipe IT XNRGY"
            }
        };

        function useMaintenanceTemplate(templateName) {
            const template = maintenanceTemplates[templateName];
            if (!template) return;
            
            const endTimeEl = document.getElementById('maintenanceEndTime');
            let endTimeStr = endTimeEl.value ? new Date(endTimeEl.value).toLocaleString('fr-FR') : '[Non d√©finie]';
            
            const message = template.message.replace('{endTime}', endTimeStr);
            document.getElementById('maintenanceMessage').value = message;
            
            showToast(`Template "${template.title}" appliqu√©`, 'info');
        }

        // ==================== GITHUB INTEGRATION ====================
        const GITHUB_OWNER = 'mohammedamineelgalai';
        const GITHUB_REPO = 'XnrgyEngineeringAutomationTools';
        const GITHUB_API_BASE = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}`;
        
        let githubReleases = [];
        let latestGitHubRelease = null;
        
        // Fetch releases from GitHub API (public, no auth needed)
        async function fetchGitHubReleases() {
            const statusEl = document.getElementById('githubStatus');
            const statusTextEl = document.getElementById('githubStatusText');
            const listEl = document.getElementById('githubReleasesList');
            
            // Show loading state
            statusEl.style.borderColor = '#f0883e';
            statusTextEl.textContent = 'Chargement...';
            statusTextEl.style.color = '#f0883e';
            
            listEl.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #8b949e;">
                    <div class="spinner" style="margin: 0 auto 15px;"></div>
                    <p>Connexion a GitHub...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${GITHUB_API_BASE}/releases?per_page=10`, {
                    headers: {
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                githubReleases = await response.json();
                latestGitHubRelease = githubReleases.length > 0 ? githubReleases[0] : null;
                
                // Update status - Connected
                statusEl.style.borderColor = '#3fb950';
                statusEl.style.background = 'rgba(63, 185, 80, 0.15)';
                statusTextEl.textContent = 'Connecte';
                statusTextEl.style.color = '#3fb950';
                
                // Render releases
                renderGitHubReleases();
                
                // Update deployed version if we have a latest release
                if (latestGitHubRelease) {
                    document.getElementById('deployedVersion').textContent = latestGitHubRelease.tag_name.replace('v', '');
                    const date = new Date(latestGitHubRelease.published_at);
                    document.getElementById('deployedVersionDate').textContent = `Publie le ${date.toLocaleDateString('fr-FR')}`;
                }
                
                showToast(`${githubReleases.length} releases chargees depuis GitHub`, 'success');
                
            } catch (error) {
                console.error('GitHub API Error:', error);
                
                // Update status - Error
                statusEl.style.borderColor = '#f85149';
                statusEl.style.background = 'rgba(248, 81, 73, 0.15)';
                statusTextEl.textContent = 'Erreur';
                statusTextEl.style.color = '#f85149';
                
                listEl.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #f85149;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 15px;">
                            <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <p style="font-weight: 600;">Erreur de connexion GitHub</p>
                        <p style="font-size: 0.8rem; color: #8b949e; margin-top: 8px;">${error.message}</p>
                        <button class="btn btn-sm" onclick="fetchGitHubReleases()" style="margin-top: 15px; background: #238636;">
                            Reessayer
                        </button>
                    </div>
                `;
                
                showToast('Erreur connexion GitHub: ' + error.message, 'error');
            }
        }
        
        function renderGitHubReleases() {
            const listEl = document.getElementById('githubReleasesList');
            
            if (githubReleases.length === 0) {
                listEl.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #8b949e;">
                        <p>Aucune release trouvee sur GitHub</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            githubReleases.forEach((release, index) => {
                const date = new Date(release.published_at);
                const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
                const isLatest = index === 0;
                const isPrerelease = release.prerelease;
                const isDraft = release.draft;
                
                // Get download count
                let totalDownloads = 0;
                let assetInfo = null;
                if (release.assets && release.assets.length > 0) {
                    release.assets.forEach(asset => {
                        totalDownloads += asset.download_count || 0;
                        if (asset.name.endsWith('.exe')) {
                            assetInfo = asset;
                        }
                    });
                }
                
                const tagColor = isLatest ? '#3fb950' : (isPrerelease ? '#f0883e' : '#8b949e');
                const tagLabel = isLatest ? 'Latest' : (isPrerelease ? 'Pre-release' : (isDraft ? 'Draft' : ''));
                
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #21262d; transition: background 0.2s;" 
                         onmouseover="this.style.background='#161b22'" onmouseout="this.style.background='transparent'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 8px; background: ${isLatest ? 'linear-gradient(135deg, #238636, #2ea043)' : '#21262d'}; 
                                        display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 0.9rem;">
                                ${release.tag_name.replace('v', '')}
                            </div>
                            <div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-weight: 600; color: #f0f6fc;">${release.name || release.tag_name}</span>
                                    ${tagLabel ? `<span style="font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; background: ${tagColor}20; color: ${tagColor}; border: 1px solid ${tagColor}40;">${tagLabel}</span>` : ''}
                                </div>
                                <div style="font-size: 0.75rem; color: #8b949e; margin-top: 2px;">
                                    üìÖ ${dateStr} &nbsp;‚Ä¢&nbsp; üì• ${totalDownloads} telechargements
                                    ${assetInfo ? ` &nbsp;‚Ä¢&nbsp; üì¶ ${(assetInfo.size / 1024 / 1024).toFixed(1)} MB` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-sm" onclick="selectGitHubRelease('${release.tag_name}')" 
                                    style="background: #238636; border-color: #238636; font-size: 0.75rem; padding: 4px 10px;"
                                    title="Utiliser cette version">
                                Utiliser
                            </button>
                            <a href="${release.html_url}" target="_blank" class="btn btn-sm" 
                               style="background: #21262d; border-color: #30363d; font-size: 0.75rem; padding: 4px 10px; text-decoration: none; color: #f0f6fc;">
                                Voir
                            </a>
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        // Select a GitHub release to use
        function selectGitHubRelease(tagName) {
            const release = githubReleases.find(r => r.tag_name === tagName);
            if (!release) return;
            
            // Fill the form
            document.getElementById('newVersion').value = release.tag_name.replace('v', '');
            
            // Find the .exe asset
            const exeAsset = release.assets?.find(a => a.name.endsWith('.exe'));
            if (exeAsset) {
                document.getElementById('downloadUrl').value = exeAsset.browser_download_url;
                document.getElementById('fileSize').value = `${(exeAsset.size / 1024 / 1024).toFixed(1)} MB`;
            } else {
                document.getElementById('downloadUrl').value = release.html_url;
            }
            
            // Fill release notes
            document.getElementById('releaseNotes').value = release.body || '';
            
            showToast(`Release ${tagName} selectionnee`, 'info');
            
            // Scroll to form
            document.querySelector('#page-updates .card:nth-child(3)').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Auto-fill GitHub URL from latest release
        function autoFillGitHubUrl() {
            if (!latestGitHubRelease) {
                showToast('Synchronisez d\'abord avec GitHub', 'warning');
                fetchGitHubReleases();
                return;
            }
            
            const exeAsset = latestGitHubRelease.assets?.find(a => a.name.endsWith('.exe'));
            if (exeAsset) {
                document.getElementById('downloadUrl').value = exeAsset.browser_download_url;
                document.getElementById('fileSize').value = `${(exeAsset.size / 1024 / 1024).toFixed(1)} MB`;
                showToast('URL GitHub auto-remplie', 'success');
            } else {
                document.getElementById('downloadUrl').value = `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/releases/latest`;
                showToast('Aucun fichier .exe trouve, URL generique utilisee', 'warning');
            }
        }
        
        // Preview update before publishing
        function previewUpdate() {
            const version = document.getElementById('newVersion').value.trim() || '?.?.?';
            const url = document.getElementById('downloadUrl').value.trim() || 'Non defini';
            const notes = document.getElementById('releaseNotes').value.trim() || 'Aucune note';
            const isCritical = document.getElementById('isCritical').checked;
            
            const preview = `
üì¶ APERCU DE LA MISE A JOUR

Version: ${version}
Type: ${isCritical ? '‚ö†Ô∏è CRITIQUE' : 'Standard'}

URL: ${url}

Notes:
${notes}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Publier maintenant?
            `;
            
            if (confirm(preview)) {
                publishUpdate();
            }
        }
        
        // Update Force Update status preview
        function updateForceUpdatePreview() {
            const enabled = document.getElementById('forceUpdateToggle').checked;
            const statusEl = document.getElementById('forceUpdateStatus');
            
            if (enabled) {
                statusEl.textContent = 'ACTIVE';
                statusEl.style.background = 'rgba(240, 136, 62, 0.3)';
                statusEl.style.color = '#f0883e';
            } else {
                statusEl.textContent = 'Desactive';
                statusEl.style.background = 'rgba(0,0,0,0.3)';
                statusEl.style.color = '#8b949e';
            }
        }

        function publishUpdate() {
            const version = document.getElementById('newVersion').value.trim();
            const url = document.getElementById('downloadUrl').value.trim();
            const notes = document.getElementById('releaseNotes').value.trim();
            const sha256 = document.getElementById('sha256').value.trim();
            const fileSize = document.getElementById('fileSize').value.trim();
            const isCritical = document.getElementById('isCritical').checked;
            
            if (!version) {
                showToast('Version requise', 'warning');
                return;
            }
            
            if (!url) {
                showToast('URL de telechargement requise', 'warning');
                return;
            }
            
            // Show confirmation for critical updates
            if (isCritical && !confirm('‚ö†Ô∏è ATTENTION: Cette mise a jour sera marquee comme CRITIQUE.\n\nTous les utilisateurs seront fortement incites a mettre a jour.\n\nContinuer?')) {
                return;
            }
            
            // Save to Firebase
            const updateData = {
                version: version,
                downloadUrl: url,
                releaseNotes: notes,
                sha256: sha256,
                fileSize: fileSize,
                isCritical: isCritical,
                publishedAt: new Date().toISOString(),
                publishedBy: 'Admin Panel',
                source: url.includes('github.com') ? 'GitHub Releases' : 'Manual'
            };
            
            database.ref('updates/latest').update(updateData).then(() => {
                // Also save to history
                database.ref('updates/history').push({
                    ...updateData,
                    id: `v${version}_${Date.now()}`
                });
                
                // Update current version
                database.ref('appConfig/currentVersion').set(version);
                
                showToast(`Version ${version} publiee avec succes!`, 'success');
                logAudit('update_published', `Version ${version} - ${isCritical ? 'CRITICAL' : 'Standard'}`);
                
                // Clear form
                document.getElementById('newVersion').value = '';
                document.getElementById('downloadUrl').value = '';
                document.getElementById('releaseNotes').value = '';
                document.getElementById('sha256').value = '';
                document.getElementById('fileSize').value = '';
                document.getElementById('isCritical').checked = false;
                
                // Refresh update history
                loadUpdateHistory();
            }).catch(err => {
                showToast('Erreur publication: ' + err.message, 'error');
            });
        }

        function applyForceUpdate() {
            const enabled = document.getElementById('forceUpdateToggle').checked;
            const minVersion = document.getElementById('forceMinVersion').value.trim();
            const blockApp = document.getElementById('blockUntilUpdated').checked;
            
            if (enabled && !minVersion) {
                showToast('Version minimum requise', 'warning');
                return;
            }
            
            // Confirmation for enabling
            if (enabled && !confirm(`‚ö†Ô∏è ATTENTION: Force Update va obliger TOUS les utilisateurs a mettre a jour vers la version ${minVersion} minimum.\n\n${blockApp ? 'üö´ L\'application sera BLOQUEE pour les versions anterieures!' : ''}\n\nContinuer?`)) {
                document.getElementById('forceUpdateToggle').checked = false;
                updateForceUpdatePreview();
                return;
            }
            
            database.ref('forceUpdate').update({
                enabled: enabled,
                minimumVersion: minVersion,
                blockAppUntilUpdated: blockApp,
                updatedAt: new Date().toISOString(),
                updatedBy: 'Admin Panel'
            }).then(() => {
                showToast(enabled ? `Force Update ACTIVE - Version min: ${minVersion}` : 'Force Update desactive', enabled ? 'warning' : 'success');
                logAudit('force_update_config', enabled ? `Enabled - Min: ${minVersion}` : 'Disabled');
                updateForceUpdatePreview();
            }).catch(err => {
                showToast('Erreur: ' + err.message, 'error');
            });
        }
        
        // Load update history from Firebase
        function loadUpdateHistory() {
            const listEl = document.getElementById('updateHistoryList');
            
            database.ref('updates/history').orderByChild('publishedAt').limitToLast(10).once('value', snapshot => {
                const history = [];
                snapshot.forEach(child => {
                    history.unshift({ id: child.key, ...child.val() });
                });
                
                if (history.length === 0) {
                    listEl.innerHTML = `
                        <div style="padding: 30px; text-align: center; color: var(--xnrgy-text-muted);">
                            <p>Aucune publication enregistree</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                history.forEach(item => {
                    const date = new Date(item.publishedAt);
                    const dateStr = date.toLocaleString('fr-FR');
                    
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--xnrgy-border-light);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 36px; height: 36px; border-radius: 6px; background: ${item.isCritical ? 'var(--xnrgy-red)' : 'var(--xnrgy-green)'}; 
                                            display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: 0.75rem;">
                                    ${item.version}
                                </div>
                                <div>
                                    <div style="font-weight: 500;">${item.version} ${item.isCritical ? '<span style="color: var(--xnrgy-red);">‚ö†Ô∏è Critique</span>' : ''}</div>
                                    <div style="font-size: 0.75rem; color: var(--xnrgy-text-muted);">${dateStr} ‚Ä¢ ${item.source || 'Manual'}</div>
                                </div>
                            </div>
                            <span style="font-size: 0.7rem; color: var(--xnrgy-text-muted);">${item.publishedBy || 'Admin'}</span>
                        </div>
                    `;
                });
                
                listEl.innerHTML = html;
            });
        }

        function blockUser(uid) {
            const reason = prompt('Raison du blocage:');
            if (reason === null) return;
            
            database.ref(`users/${uid}/status`).update({
                blocked: true,
                blockReason: reason,
                blockedAt: new Date().toISOString(),
                blockedBy: 'Admin Panel'
            }).then(() => {
                showToast('Utilisateur bloque', 'warning');
                logAudit('user_blocked', uid);
            });
        }

        function unblockUser(uid) {
            database.ref(`users/${uid}/status`).update({
                blocked: false,
                blockReason: '',
                blockedAt: '',
                blockedBy: ''
            }).then(() => {
                showToast('Utilisateur debloque', 'success');
                logAudit('user_unblocked', uid);
            });
        }

        function blockDevice(id) {
            const reason = prompt('Raison du blocage:');
            if (reason === null) return;
            
            database.ref(`devices/${id}/status`).update({
                blocked: true,
                blockReason: reason,
                blockedAt: new Date().toISOString(),
                blockedBy: 'Admin Panel'
            }).then(() => {
                showToast('Poste bloque', 'warning');
                logAudit('device_blocked', id);
            });
        }

        function unblockDevice(id) {
            database.ref(`devices/${id}/status`).update({
                blocked: false,
                blockReason: '',
                blockedAt: '',
                blockedBy: ''
            }).then(() => {
                showToast('Poste debloque', 'success');
                logAudit('device_unblocked', id);
            });
        }

        function toggleFeature(id, enabled) {
            database.ref(`featureFlags/${id}/enabled`).set(enabled)
                .then(() => showToast(`Feature ${id} ${enabled ? 'activee' : 'desactivee'}`, 'info'));
        }

        function toggleSite(id, enabled) {
            database.ref(`sites/${id}/enabled`).set(enabled)
                .then(() => showToast(`Site ${id} ${enabled ? 'active' : 'desactive'}`, 'info'));
        }

        function sendBroadcast() {
            const type = document.getElementById('broadcastType').value;
            const priority = document.getElementById('broadcastPriority').value;
            const title = document.getElementById('broadcastTitle').value.trim();
            const message = document.getElementById('broadcastMessage').value.trim();
            const target = document.getElementById('broadcastTarget').value;
            const showPopup = document.getElementById('broadcastPopup').checked;
            const requireAck = document.getElementById('broadcastAck').checked;
            
            if (!title || !message) {
                showToast('Titre et message requis', 'warning');
                return;
            }
            
            const broadcastId = 'msg_' + Date.now();
            database.ref(`broadcasts/${broadcastId}`).set({
                id: broadcastId,
                type: type,
                priority: priority,
                title: title,
                message: message,
                target: { type: target },
                display: {
                    showAsPopup: showPopup,
                    showAsBanner: true,
                    dismissible: true,
                    requireAcknowledgment: requireAck
                },
                status: {
                    active: true,
                    sentAt: new Date().toISOString(),
                    sentBy: 'Admin Panel',
                    viewCount: 0
                }
            }).then(() => {
                showToast('Broadcast envoye!', 'success');
                document.getElementById('broadcastTitle').value = '';
                document.getElementById('broadcastMessage').value = '';
                document.getElementById('broadcastTemplate').value = '';
                logAudit('broadcast_sent', title);
                refreshBroadcasts();
            });
        }

        // ==================== TEMPLATES DE MESSAGES ====================
        const messageTemplates = {
            // Maintenance
            maint_planned: {
                type: 'warning',
                priority: 'normal',
                title: 'Maintenance planifiee',
                message: 'Une maintenance est prevue le [DATE] de [HEURE_DEBUT] a [HEURE_FIN].\n\nVeuillez sauvegarder vos travaux avant cette periode.\n\nMerci de votre comprehension.'
            },
            maint_urgent: {
                type: 'error',
                priority: 'critical',
                title: 'Maintenance urgente en cours',
                message: 'Une maintenance urgente est en cours.\n\nLes services seront temporairement indisponibles.\n\nNous vous informerons des que les services seront retablis.'
            },
            maint_complete: {
                type: 'success',
                priority: 'normal',
                title: 'Maintenance terminee',
                message: 'La maintenance est terminee avec succes.\n\nTous les services sont maintenant disponibles.\n\nMerci de votre patience!'
            },
            // Mises a jour
            update_available: {
                type: 'info',
                priority: 'normal',
                title: 'Nouvelle version disponible',
                message: 'Une nouvelle version de XEAT est disponible (v[VERSION]).\n\nNouveautes:\n- [FEATURE_1]\n- [FEATURE_2]\n\nVeuillez mettre a jour des que possible.'
            },
            update_required: {
                type: 'warning',
                priority: 'high',
                title: 'Mise a jour requise',
                message: 'Une mise a jour importante est requise pour continuer a utiliser XEAT.\n\nVeuillez fermer l\'application et la relancer pour appliquer la mise a jour.'
            },
            update_complete: {
                type: 'success',
                priority: 'normal',
                title: 'Mise a jour installee',
                message: 'La mise a jour a ete installee avec succes!\n\nVersion actuelle: v[VERSION]\n\nBonne utilisation!'
            },
            // Annonces
            announce_meeting: {
                type: 'info',
                priority: 'normal',
                title: 'Reunion d\'equipe',
                message: 'Rappel: Reunion d\'equipe le [DATE] a [HEURE].\n\nLieu: [LIEU]\nOrdre du jour: [SUJET]\n\nMerci de confirmer votre presence.'
            },
            announce_info: {
                type: 'info',
                priority: 'low',
                title: 'Information',
                message: '[Votre message ici]'
            },
            announce_reminder: {
                type: 'warning',
                priority: 'normal',
                title: 'Rappel important',
                message: 'Rappel: [SUJET]\n\nDate limite: [DATE]\n\nMerci de prendre les actions necessaires.'
            },
            // Alertes
            alert_vault: {
                type: 'error',
                priority: 'high',
                title: 'Probleme Vault detecte',
                message: 'Un probleme avec Autodesk Vault a ete detecte.\n\nAction recommandee:\n1. Sauvegardez vos travaux localement\n2. Ne faites pas de Check-In pour le moment\n3. Attendez la resolution du probleme\n\nNous travaillons a resoudre ce probleme.'
            },
            alert_network: {
                type: 'error',
                priority: 'high',
                title: 'Probleme reseau',
                message: 'Des problemes de connectivite reseau ont ete detectes.\n\nCertaines fonctionnalites peuvent etre affectees.\n\nL\'equipe IT travaille sur la resolution.'
            },
            alert_urgent: {
                type: 'error',
                priority: 'critical',
                title: 'ALERTE URGENTE',
                message: '[DESCRIPTION DE L\'URGENCE]\n\nAction requise immediatement:\n- [ACTION_1]\n- [ACTION_2]'
            }
        };

        function applyTemplate() {
            const templateId = document.getElementById('broadcastTemplate').value;
            if (!templateId || !messageTemplates[templateId]) return;
            
            const template = messageTemplates[templateId];
            document.getElementById('broadcastType').value = template.type;
            document.getElementById('broadcastPriority').value = template.priority;
            document.getElementById('broadcastTitle').value = template.title;
            document.getElementById('broadcastMessage').value = template.message;
            
            showToast('Template applique - Modifiez les [CHAMPS] selon vos besoins', 'info');
        }

        // ==================== MESSAGE DE BIENVENUE ====================
        function loadWelcomeMessage() {
            database.ref('welcomeMessage').once('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('welcomeEnabled').checked = data.enabled || false;
                    document.getElementById('welcomeTitle').value = data.title || '';
                    document.getElementById('welcomeMessage').value = data.message || '';
                    updateWelcomeStatus(data.enabled);
                }
            });
        }

        function saveWelcomeMessage() {
            const enabled = document.getElementById('welcomeEnabled').checked;
            const titleInput = document.getElementById('welcomeTitle');
            const messageInput = document.getElementById('welcomeMessage');
            
            // Utiliser la valeur ou le placeholder si vide
            const title = titleInput.value.trim() || titleInput.placeholder;
            const message = messageInput.value.trim() || messageInput.placeholder;
            
            database.ref('welcomeMessage').set({
                enabled: enabled,
                title: title,
                message: message,
                type: 'info',
                updatedAt: new Date().toISOString(),
                updatedBy: 'Admin Panel'
            }).then(() => {
                // Mettre les valeurs dans les champs pour montrer ce qui a ete sauvegarde
                titleInput.value = title;
                messageInput.value = message;
                
                showToast(enabled ? 'Message de bienvenue active!' : 'Message de bienvenue desactive', 'success');
                updateWelcomeStatus(enabled);
                logAudit('welcome_message_updated', enabled ? 'enabled' : 'disabled');
            }).catch(err => {
                showToast('Erreur: ' + err.message, 'error');
            });
        }

        function updateWelcomeStatus(enabled) {
            const badge = document.getElementById('welcomeStatus');
            badge.textContent = enabled ? 'Actif' : 'Inactif';
            badge.style.background = enabled ? 'var(--xnrgy-green)' : 'var(--xnrgy-text-muted)';
            badge.style.color = 'white';
            badge.style.padding = '4px 10px';
            badge.style.borderRadius = '12px';
            badge.style.fontSize = '0.75rem';
        }

        // ==================== NOUVEAU SYSTEME DE MESSAGES DE BIENVENUE ====================
        function loadWelcomeMessages() {
            database.ref('welcomeMessages').once('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    // Premier lancement (installation)
                    if (data.firstInstall) {
                        document.getElementById('welcomeFirstInstallEnabled').checked = data.firstInstall.enabled !== false;
                        document.getElementById('welcomeFirstInstallTitle').value = data.firstInstall.title || 'Bienvenue sur XEAT!';
                        document.getElementById('welcomeFirstInstallMessage').value = data.firstInstall.message || '';
                        document.getElementById('welcomeFirstInstallType').value = data.firstInstall.type || 'info';
                    }
                    
                    // Nouvel utilisateur Windows
                    if (data.newUserOnDevice) {
                        document.getElementById('welcomeNewUserEnabled').checked = data.newUserOnDevice.enabled !== false;
                        document.getElementById('welcomeNewUserTitle').value = data.newUserOnDevice.title || 'Bienvenue!';
                        document.getElementById('welcomeNewUserMessage').value = data.newUserOnDevice.message || '';
                        document.getElementById('welcomeNewUserType').value = data.newUserOnDevice.type || 'info';
                    }
                    
                    // Message global (drop custom)
                    if (data.global) {
                        document.getElementById('welcomeGlobalEnabled').checked = data.global.enabled || false;
                        document.getElementById('welcomeGlobalTitle').value = data.global.title || '';
                        document.getElementById('welcomeGlobalMessage').value = data.global.message || '';
                        document.getElementById('welcomeGlobalShowOnce').checked = data.global.showOnce !== false;
                    }
                    
                    showToast('Messages de bienvenue charges', 'info');
                }
            }).catch(err => {
                showToast('Erreur chargement: ' + err.message, 'error');
            });
        }

        function saveWelcomeMessages() {
            const welcomeMessages = {
                firstInstall: {
                    enabled: document.getElementById('welcomeFirstInstallEnabled').checked,
                    title: document.getElementById('welcomeFirstInstallTitle').value.trim() || 'Bienvenue sur XEAT!',
                    message: document.getElementById('welcomeFirstInstallMessage').value.trim(),
                    type: document.getElementById('welcomeFirstInstallType').value,
                    showOnce: true,
                    targetUsers: 'all'
                },
                newUserOnDevice: {
                    enabled: document.getElementById('welcomeNewUserEnabled').checked,
                    title: document.getElementById('welcomeNewUserTitle').value.trim() || 'Bienvenue!',
                    message: document.getElementById('welcomeNewUserMessage').value.trim(),
                    type: document.getElementById('welcomeNewUserType').value,
                    showOnce: true,
                    targetUsers: 'new'
                },
                global: {
                    enabled: document.getElementById('welcomeGlobalEnabled').checked,
                    title: document.getElementById('welcomeGlobalTitle').value.trim(),
                    message: document.getElementById('welcomeGlobalMessage').value.trim(),
                    type: 'info',
                    showOnce: document.getElementById('welcomeGlobalShowOnce').checked,
                    targetUsers: 'all'
                }
            };
            
            database.ref('welcomeMessages').set(welcomeMessages).then(() => {
                showToast('Messages de bienvenue sauvegardes!', 'success');
                logAudit('welcome_messages_updated', 'All 3 types configured');
                
                // Mettre a jour le badge de statut
                const activeCount = [
                    welcomeMessages.firstInstall.enabled,
                    welcomeMessages.newUserOnDevice.enabled,
                    welcomeMessages.global.enabled
                ].filter(Boolean).length;
                
                const badge = document.getElementById('welcomeStatus');
                badge.textContent = activeCount + ' type(s) actif(s)';
                badge.style.background = activeCount > 0 ? 'var(--xnrgy-green)' : 'var(--xnrgy-text-muted)';
            }).catch(err => {
                showToast('Erreur: ' + err.message, 'error');
            });
        }

        // ==================== RAFRAICHIR BROADCASTS ====================
        function refreshBroadcasts() {
            updateBroadcastsList();
            showToast('Liste actualisee', 'info');
        }

        function forceLogoutAll() {
            if (!confirm('‚ö†Ô∏è Deconnecter TOUS les utilisateurs?')) return;
            
            database.ref('commands/forceLogoutAll').set({
                enabled: true,
                timestamp: new Date().toISOString()
            }).then(() => {
                showToast('Commande de deconnexion envoyee', 'warning');
                logAudit('force_logout_all', 'all users');
            });
        }

        // ==================== UTILITIES ====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('page-' + pageId).classList.add('active');
            event.target.closest('.nav-item')?.classList.add('active');
            
            // Charger les donnees specifiques a la page
            if (pageId === 'telemetry') {
                updateTelemetryPage();
            } else if (pageId === 'audit') {
                updateAuditPage();
            } else if (pageId === 'security') {
                loadSecuritySettings();
            } else if (pageId === 'settings') {
                loadAppSettings();
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function setConnectionStatus(connected) {
            const el = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            el.className = `status-badge ${connected ? 'online' : 'offline'}`;
            text.textContent = connected ? 'Connecte' : 'Deconnecte';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function refreshData() {
            showToast('Actualisation...', 'info');
        }

        function exportDatabase() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `xeat-firebase-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('Export telecharge', 'success');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleString('fr-CA');
            } catch {
                return dateStr;
            }
        }

        function getRoleColor(role) {
            const colors = {
                admin: '#E81123',
                adminDesigner: '#FF8C00',
                developer: '#7C4DFF',
                designer: '#0078D4',
                user: '#00D26A',
                viewer: '#6B7A8F'
            };
            return colors[role] || '#6B7A8F';
        }

        function logAudit(action, details) {
            const logId = 'log_' + Date.now();
            database.ref(`auditLog/${logId}`).set({
                id: logId,
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                userId: 'admin',
                userName: 'Admin Panel'
            });
        }

        function logout() {
            if (confirm('Se deconnecter?')) {
                auth.signOut().then(() => {
                    window.location.reload();
                });
            }
        }

        // Placeholder functions for modal dialogs
        function showAddUserModal() { alert('Fonctionnalite a implementer: Ajouter utilisateur'); }
        function showAddDeviceModal() { alert('Fonctionnalit√© √† impl√©menter: Ajouter poste'); }
        
        // ==================== VIEW USER DETAILS (INLINE) ====================
        function toggleUserDetails(uid) {
            console.log('[>] toggleUserDetails appel√© pour:', uid);
            
            const detailsPanel = document.getElementById(`user-details-${uid}`);
            const btn = document.getElementById(`btn-details-user-${uid}`);
            
            console.log('[i] detailsPanel:', detailsPanel);
            
            if (!detailsPanel) {
                console.error('[-] Panel de details utilisateur non trouv√© pour:', uid);
                return;
            }
            
            const isHidden = detailsPanel.style.display === 'none' || detailsPanel.style.display === '';
            
            if (isHidden) {
                // Fermer tous les autres details ouverts
                document.querySelectorAll('.user-details-panel').forEach(panel => {
                    panel.style.display = 'none';
                });
                document.querySelectorAll('[id^="btn-details-user-"]').forEach(b => {
                    b.innerHTML = 'üìã Details';
                });
                
                // Charger et afficher les details
                loadUserDetails(uid);
                detailsPanel.style.display = 'block';
                if (btn) btn.innerHTML = 'üîº Masquer';
                console.log('[+] Details utilisateur affiches');
            } else {
                detailsPanel.style.display = 'none';
                if (btn) btn.innerHTML = 'üìã Details';
                console.log('[+] Details utilisateur masques');
            }
        }
        
        function loadUserDetails(uid) {
            const user = appData.users?.[uid];
            if (!user) return;
            
            const profile = user.profile || user;
            const org = user.organization || {};
            const status = user.status || {};
            const prefs = user.preferences || {};
            const sessions = user.sessions || {};
            
            const html = `
                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px;">
                    <!-- Profil -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-cyan);">
                        <h4 style="color:var(--xnrgy-cyan); margin:0 0 10px 0;">üë§ Profil</h4>
                        <p><strong>Nom complet:</strong> ${profile.fullName || 'N/A'}</p>
                        <p><strong>Email:</strong> ${profile.email || 'N/A'}</p>
                        <p><strong>Utilisateur:</strong> ${profile.username || 'N/A'}</p>
                        <p><strong>UID:</strong> <code style="font-size:0.7rem;">${uid}</code></p>
                    </div>
                    
                    <!-- Organisation -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-purple);">
                        <h4 style="color:var(--xnrgy-purple); margin:0 0 10px 0;">üè¢ Organisation</h4>
                        <p><strong>R√¥le:</strong> <span style="color:${getRoleColor(org.role)}">${getRoleIcon(org.role)} ${org.role || 'user'}</span></p>
                        <p><strong>Site:</strong> üìç ${org.site || 'N/A'}</p>
                        <p><strong>D√©partement:</strong> ${org.department || 'N/A'}</p>
                        <p><strong>√âquipe:</strong> ${org.team || 'N/A'}</p>
                    </div>
                    
                    <!-- Statut -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid ${status.online ? 'var(--xnrgy-green)' : 'var(--xnrgy-red)'};">
                        <h4 style="color:${status.online ? 'var(--xnrgy-green)' : 'var(--xnrgy-red)'}; margin:0 0 10px 0;">${status.online ? 'üü¢' : 'üî¥'} Statut</h4>
                        <p><strong>En ligne:</strong> ${status.online ? '‚úÖ Oui' : '‚ùå Non'}</p>
                        <p><strong>Derni√®re activit√©:</strong> üïê ${formatDate(status.lastActive)}</p>
                        <p><strong>Derni√®re connexion:</strong> üïê ${formatDate(sessions.lastLogin)}</p>
                        <p><strong>Poste actuel:</strong> üíª ${sessions.currentDevice || 'N/A'}</p>
                    </div>
                    
                    <!-- Preferences -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-orange);">
                        <h4 style="color:var(--xnrgy-orange); margin:0 0 10px 0;">‚öôÔ∏è Pr√©f√©rences</h4>
                        <p><strong>Th√®me:</strong> ${prefs.theme || 'default'}</p>
                        <p><strong>Langue:</strong> üåê ${prefs.language || 'fr'}</p>
                        <p><strong>Notifications:</strong> ${prefs.notifications ? 'üîî Activ√©es' : 'üîï D√©sactiv√©es'}</p>
                        <p><strong>Auto-update:</strong> ${prefs.autoUpdate !== false ? '‚úÖ Actif' : '‚ùå Inactif'}</p>
                    </div>
                    
                    <!-- Sessions -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-blue);">
                        <h4 style="color:var(--xnrgy-blue); margin:0 0 10px 0;">üìä Sessions</h4>
                        <p><strong>Total sessions:</strong> ${sessions.totalSessions || 0}</p>
                        <p><strong>Session actuelle:</strong> ${sessions.currentSessionId || 'Aucune'}</p>
                        <p><strong>IP derni√®re co:</strong> üåê ${sessions.lastIpAddress || 'N/A'}</p>
                    </div>
                    
                    <!-- Compte -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-text-muted);">
                        <h4 style="color:var(--xnrgy-text-muted); margin:0 0 10px 0;">üîê Compte</h4>
                        <p><strong>Cr√©√© le:</strong> üìÖ ${profile.createdAt || 'N/A'}</p>
                        <p><strong>Mis √† jour:</strong> üìÖ ${formatDate(profile.updatedAt)}</p>
                        <p><strong>Bloqu√©:</strong> ${status.blocked ? '<span style="color:var(--xnrgy-red)">üö´ Oui</span>' : '‚úÖ Non'}</p>
                    </div>
                </div>
            `;
            
            const container = document.getElementById(`user-details-content-${uid}`);
            if (container) container.innerHTML = html;
        }
        
        function viewUser(uid) {
            toggleUserDetails(uid);
        }
        
        // ==================== VIEW DEVICE DETAILS (INLINE) ====================
        function toggleDeviceDetails(id) {
            console.log('[>] toggleDeviceDetails appel√© pour:', id);
            
            const detailsPanel = document.getElementById(`device-details-${id}`);
            const btn = document.getElementById(`btn-details-${id}`);
            
            console.log('[i] detailsPanel:', detailsPanel);
            
            if (!detailsPanel) {
                console.error('[-] Panel de details non trouv√© pour:', id);
                return;
            }
            
            const isHidden = detailsPanel.style.display === 'none' || detailsPanel.style.display === '';
            console.log('[i] isHidden:', isHidden);
            
            if (isHidden) {
                // Fermer tous les autres details ouverts
                document.querySelectorAll('.device-details-panel').forEach(panel => {
                    panel.style.display = 'none';
                });
                document.querySelectorAll('[id^="btn-details-"]').forEach(b => {
                    if (!b.id.includes('user')) b.innerHTML = '&#9660; Details';
                });
                
                // Charger et afficher les details
                loadDeviceDetails(id);
                detailsPanel.style.display = 'block';
                if (btn) btn.innerHTML = 'üîº Masquer';
                console.log('[+] Details affiches');
            } else {
                detailsPanel.style.display = 'none';
                if (btn) btn.innerHTML = 'üìã Details';
                console.log('[+] Details masques');
            }
        }
        
        function loadDeviceDetails(id) {
            console.log('[>] loadDeviceDetails appel√© pour:', id);
            
            const device = appData.devices?.[id];
            console.log('[i] Device trouv√©:', device ? 'OUI' : 'NON');
            
            if (!device) {
                console.error('[-] Device non trouv√© dans appData.devices');
                console.log('[i] Devices disponibles:', Object.keys(appData.devices || {}));
                return;
            }
            
            const reg = device.registration || {};
            const org = device.organization || {};
            const status = device.status || {};
            const sys = device.system || {};
            const hw = device.hardware || {};
            const net = device.network || {};
            const sw = device.software || {};
            const hb = device.heartbeat || {};
            const usage = device.usage || {};
            
            const html = `
                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:15px;">
                    <!-- Systeme -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-cyan);">
                        <h4 style="color:var(--xnrgy-cyan); margin:0 0 10px 0;">üñ•Ô∏è Syst√®me</h4>
                        <p><strong>OS:</strong> ${sys.osName || 'N/A'}</p>
                        <p><strong>Version:</strong> ${sys.osVersion || 'N/A'}</p>
                        <p><strong>Build:</strong> ${sys.osBuild || 'N/A'}</p>
                        <p><strong>Archi:</strong> ${sys.osArchitecture || 'N/A'}</p>
                        <p><strong>Fabricant:</strong> ${sys.manufacturer || 'N/A'}</p>
                        <p><strong>Mod√®le:</strong> ${sys.model || 'N/A'}</p>
                        <p><strong>S/N:</strong> ${sys.serialNumber || 'N/A'}</p>
                    </div>
                    
                    <!-- Hardware -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-orange);">
                        <h4 style="color:var(--xnrgy-orange); margin:0 0 10px 0;">‚öôÔ∏è Hardware</h4>
                        <p><strong>CPU:</strong> ${hw.processor || 'N/A'}</p>
                        <p><strong>Coeurs:</strong> ${hw.processorCores || 'N/A'}</p>
                        <p><strong>Fr√©q:</strong> ${hw.processorSpeed || 'N/A'}</p>
                        <p><strong>RAM:</strong> ${hw.ramTotalGB || 0} GB</p>
                        <p><strong>GPU:</strong> ${hw.gpuName || 'N/A'}</p>
                        <p><strong>VRAM:</strong> ${hw.gpuMemoryGB || 0} GB</p>
                        <p><strong>Disque:</strong> üíæ ${hw.diskTotalGB || 0} GB (${hw.diskFreeGB || 0} libre)</p>
                    </div>
                    
                    <!-- Reseau -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-blue);">
                        <h4 style="color:var(--xnrgy-blue); margin:0 0 10px 0;">üåê R√©seau</h4>
                        <p><strong>IP:</strong> ${net.ipAddressLocal || 'N/A'}</p>
                        <p><strong>MAC:</strong> ${net.macAddress || 'N/A'}</p>
                        <p><strong>Hostname:</strong> ${net.hostname || 'N/A'}</p>
                        <p><strong>Vitesse:</strong> ${net.networkSpeed || 'N/A'}</p>
                        <p><strong>Domaine:</strong> ${sys.domain || 'N/A'}</p>
                    </div>
                    
                    <!-- Logiciels -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-green);">
                        <h4 style="color:var(--xnrgy-green); margin:0 0 10px 0;">üì¶ Logiciels</h4>
                        <p><strong>XEAT:</strong> ${sw.xeatVersion || 'N/A'}</p>
                        <p><strong>Inventor:</strong> ${sw.inventorYear || 'N/A'} (${sw.inventorVersion || 'N/A'})</p>
                        <p><strong>Vault:</strong> ${sw.vaultVersion || 'N/A'}</p>
                        <p><strong>Serveur:</strong> üñ•Ô∏è ${sw.vaultServer || 'N/A'}</p>
                        <p><strong>.NET:</strong> ${sw.dotnetVersion || 'N/A'}</p>
                        <p><strong>Office:</strong> ${sw.officeVersion || 'N/A'}</p>
                    </div>
                    
                    <!-- Organisation -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-purple);">
                        <h4 style="color:var(--xnrgy-purple); margin:0 0 10px 0;">üè¢ Organisation</h4>
                        <p><strong>Site:</strong> üìç ${org.site || 'N/A'}</p>
                        <p><strong>Dept:</strong> ${org.department || 'N/A'}</p>
                        <p><strong>Assign√© √†:</strong> üë§ ${org.assignedTo || 'N/A'}</p>
                        <p><strong>Asset Tag:</strong> üè∑Ô∏è ${org.assetTag || 'N/A'}</p>
                    </div>
                    
                    <!-- Performance -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid ${hb.status === 'online' ? 'var(--xnrgy-green)' : 'var(--xnrgy-red)'};">
                        <h4 style="color:${hb.status === 'online' ? 'var(--xnrgy-green)' : 'var(--xnrgy-red)'}; margin:0 0 10px 0;">${hb.status === 'online' ? 'üü¢' : 'üî¥'} Performance</h4>
                        <p><strong>Statut:</strong> ${hb.status === 'online' ? '‚úÖ En ligne' : '‚ùå Hors ligne'}</p>
                        <p><strong>CPU:</strong> üìä ${hb.cpuUsage || 0}%</p>
                        <p><strong>RAM:</strong> üìä ${hb.ramUsage || 0}%</p>
                        <p><strong>Disque:</strong> üìä ${hb.diskUsage || 0}%</p>
                        <p><strong>Heartbeat:</strong> üïê ${formatDate(hb.lastHeartbeat)}</p>
                    </div>
                    
                    <!-- Utilisation -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-text-muted);">
                        <h4 style="color:var(--xnrgy-text-muted); margin:0 0 10px 0;">üìà Utilisation</h4>
                        <p><strong>Sessions:</strong> ${usage.totalSessions || 0}</p>
                        <p><strong>Uploads:</strong> ‚¨ÜÔ∏è ${usage.totalUploads || 0}</p>
                        <p><strong>Modules:</strong> üìê ${usage.totalModulesCreated || 0}</p>
                        <p><strong>Enregistr√©:</strong> üìÖ ${reg.registeredAt || 'N/A'}</p>
                    </div>
                    
                    <!-- Utilisateur actuel -->
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border-left:3px solid var(--xnrgy-cyan);">
                        <h4 style="color:var(--xnrgy-cyan); margin:0 0 10px 0;">üë§ Utilisateur</h4>
                        <p><strong>Actuel:</strong> ${status.currentUser || 'Aucun'}</p>
                        <p><strong>Derni√®re co:</strong> üïê ${formatDate(status.lastSeen)}</p>
                        <p><strong>ID Machine:</strong> <code style="font-size:0.65rem;">${id}</code></p>
                    </div>
                </div>
                
                <!-- NOUVELLE SECTION: Historique d'Installation -->
                <div style="margin-top:15px;">
                    <div style="background:var(--xnrgy-bg-dark); padding:15px; border-radius:8px; border:1px solid rgba(0,212,255,0.3);">
                        <h4 style="color:var(--xnrgy-cyan); margin:0 0 15px 0;">üì• Historique d'Installation / D√©sinstallation</h4>
                        <div id="installation-history-${id}" style="max-height:200px; overflow-y:auto;">
                            ${generateInstallationHistoryHTML(device.installationHistory, sw)}
                        </div>
                    </div>
                </div>
            `;
            
            const container = document.getElementById(`device-details-content-${id}`);
            console.log('[i] Container trouv√©:', container ? 'OUI' : 'NON');
            if (container) {
                container.innerHTML = html;
                console.log('[+] Contenu HTML inject√© avec succes');
            } else {
                console.error('[-] Container non trouv√©: device-details-content-' + id);
            }
        }
        
        // G√©n√®re le HTML pour l'historique d'installation
        function generateInstallationHistoryHTML(history, software) {
            if (!history || Object.keys(history).length === 0) {
                // Si pas d'historique, afficher les infos de base depuis software
                const installedAt = software?.xeatInstalledAt || 'N/A';
                const version = software?.xeatVersion || 'N/A';
                return `
                    <div style="display:flex; align-items:center; gap:10px; padding:10px; background:rgba(63,185,80,0.1); border-radius:6px; border-left:3px solid var(--xnrgy-green);">
                        <span style="font-size:1.2rem;">üì•</span>
                        <div style="flex:1;">
                            <strong style="color:var(--xnrgy-green);">Installation initiale</strong>
                            <p style="margin:5px 0 0 0; font-size:0.85rem; color:var(--xnrgy-text-muted);">
                                Version: <span style="color:var(--xnrgy-cyan);">${version}</span> | 
                                Date: <span style="color:var(--xnrgy-text-primary);">${formatDate(installedAt)}</span>
                            </p>
                        </div>
                    </div>
                    <p style="text-align:center; color:var(--xnrgy-text-muted); margin-top:10px; font-size:0.8rem;">
                        <em>L'historique d√©taill√© sera disponible apr√®s la prochaine installation/mise √† jour.</em>
                    </p>
                `;
            }
            
            // Trier par timestamp (plus r√©cent en premier)
            const entries = Object.entries(history).sort((a, b) => {
                const tsA = a[1].timestamp || '';
                const tsB = b[1].timestamp || '';
                return tsB.localeCompare(tsA);
            });
            
            let html = '<div style="display:flex; flex-direction:column; gap:8px;">';
            
            for (const [key, entry] of entries) {
                const isInstall = entry.action === 'install';
                const isUninstall = entry.action === 'uninstall';
                const isUpdate = entry.action === 'update';
                
                const color = isUninstall ? 'var(--xnrgy-red)' : (isUpdate ? 'var(--xnrgy-orange)' : 'var(--xnrgy-green)');
                const bgColor = isUninstall ? 'rgba(248,81,73,0.1)' : (isUpdate ? 'rgba(240,136,62,0.1)' : 'rgba(63,185,80,0.1)');
                const icon = isUninstall ? 'üóëÔ∏è' : (isUpdate ? 'üîÑ' : 'üì•');
                const label = isUninstall ? 'D√©sinstallation' : (isUpdate ? 'Mise √† jour' : 'Installation');
                
                html += `
                    <div style="display:flex; align-items:flex-start; gap:10px; padding:10px; background:${bgColor}; border-radius:6px; border-left:3px solid ${color};">
                        <span style="font-size:1.2rem;">${icon}</span>
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong style="color:${color};">${label}</strong>
                                <span style="font-size:0.75rem; color:var(--xnrgy-text-muted);">${formatDate(entry.timestamp)}</span>
                            </div>
                            <div style="margin-top:5px; font-size:0.85rem;">
                                <p style="margin:2px 0; color:var(--xnrgy-text-secondary);">
                                    <strong>Version:</strong> <span style="color:var(--xnrgy-cyan);">${entry.version || 'N/A'}</span>
                                </p>
                                <p style="margin:2px 0; color:var(--xnrgy-text-secondary);">
                                    <strong>Par:</strong> ${entry.installedBy || entry.uninstalledBy || entry.updatedBy || 'N/A'}
                                </p>
                                ${entry.installPath ? `<p style="margin:2px 0; color:var(--xnrgy-text-muted); font-size:0.75rem;"><strong>Chemin:</strong> ${entry.installPath}</p>` : ''}
                                ${entry.notes ? `<p style="margin:2px 0; color:var(--xnrgy-text-muted); font-style:italic; font-size:0.8rem;">${entry.notes}</p>` : ''}
                                ${entry.success === false ? `<p style="margin:2px 0; color:var(--xnrgy-red);"><strong>‚ö†Ô∏è √âchec</strong></p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        function viewDevice(id) {
            toggleDeviceDetails(id);
        }
        
        function filterUsers() { /* TODO */ }
        function filterDevices() { /* TODO */ }
        function filterUsersByRole(role) { /* TODO */ }
        function filterUsersByStatus(status) { /* TODO */ }
        function filterDevicesByStatus(status) { /* TODO */ }
        
        async function saveSecuritySettings() {
            try {
                const settings = {
                    maxLoginAttempts: parseInt(document.getElementById('maxLoginAttempts').value) || 5,
                    lockoutDuration: parseInt(document.getElementById('lockoutDuration').value) || 30,
                    sessionTimeout: parseInt(document.getElementById('sessionTimeout').value) || 480,
                    maxSessions: parseInt(document.getElementById('maxSessions').value) || 3,
                    enforceDeviceApproval: document.getElementById('enforceDeviceApproval').checked,
                    allowMultipleSessions: document.getElementById('allowMultipleSessions').checked,
                    enableIpWhitelist: document.getElementById('enableIpWhitelist').checked
                };
                
                await database.ref('security/loginPolicy').update({
                    maxLoginAttempts: settings.maxLoginAttempts,
                    lockoutDuration: settings.lockoutDuration,
                    sessionTimeout: settings.sessionTimeout,
                    maxConcurrentSessions: settings.maxSessions
                });
                
                await database.ref('security/devicePolicy').update({
                    requireApproval: settings.enforceDeviceApproval,
                    allowMultipleSessions: settings.allowMultipleSessions
                });
                
                await database.ref('security/networkPolicy').update({
                    enableIpWhitelist: settings.enableIpWhitelist
                });
                
                // Mettre a jour les donnees locales
                if (!appData.security) appData.security = {};
                appData.security.loginPolicy = { ...appData.security.loginPolicy, ...settings };
                
                logAudit('security_settings_updated', 'Parametres de securite modifies');
                showToast('Parametres de securite sauvegardes', 'success');
            } catch (error) {
                console.error('Erreur sauvegarde securite:', error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }
        
        async function saveSettings() {
            try {
                const settings = {
                    appName: document.getElementById('appName').value,
                    shortName: document.getElementById('appShortName').value,
                    supportEmail: document.getElementById('supportEmail').value,
                    heartbeatInterval: parseInt(document.getElementById('heartbeatInterval').value) || 60000,
                    debugMode: document.getElementById('debugMode').checked,
                    telemetryEnabled: document.getElementById('enableTelemetry').checked
                };
                
                await database.ref('appConfig').update({
                    appName: settings.appName,
                    shortName: settings.shortName,
                    supportEmail: settings.supportEmail
                });
                
                await database.ref('featureFlags').update({
                    debugMode: settings.debugMode,
                    telemetryCollection: settings.telemetryEnabled
                });
                
                await database.ref('devices/templateDevice/heartbeat').update({
                    intervalMs: settings.heartbeatInterval
                });
                
                // Mettre a jour les donnees locales
                if (!appData.appConfig) appData.appConfig = {};
                appData.appConfig.appName = settings.appName;
                appData.appConfig.shortName = settings.shortName;
                
                logAudit('app_settings_updated', 'Configuration application modifiee');
                showToast('Parametres sauvegardes', 'success');
            } catch (error) {
                console.error('Erreur sauvegarde parametres:', error);
                showToast('Erreur: ' + error.message, 'error');
            }
        }
        
        function scheduleMaintenace() { showToast('Maintenance planifiee', 'success'); }
        
        // ==================== LOAD SETTINGS ====================
        function loadSecuritySettings() {
            const loginPolicy = appData.security?.loginPolicy || {};
            const devicePolicy = appData.security?.devicePolicy || {};
            const networkPolicy = appData.security?.networkPolicy || {};
            
            document.getElementById('maxLoginAttempts').value = loginPolicy.maxLoginAttempts || 5;
            document.getElementById('lockoutDuration').value = loginPolicy.lockoutDuration || 30;
            document.getElementById('sessionTimeout').value = loginPolicy.sessionTimeout || 480;
            document.getElementById('maxSessions').value = loginPolicy.maxConcurrentSessions || 3;
            document.getElementById('enforceDeviceApproval').checked = devicePolicy.requireApproval || false;
            document.getElementById('allowMultipleSessions').checked = devicePolicy.allowMultipleSessions !== false;
            document.getElementById('enableIpWhitelist').checked = networkPolicy.enableIpWhitelist || false;
        }
        
        function loadAppSettings() {
            const appConfig = appData.appConfig || {};
            const featureFlags = appData.featureFlags || {};
            
            document.getElementById('appName').value = appConfig.appName || 'XNRGY Engineering Automation Tools';
            document.getElementById('appShortName').value = appConfig.shortName || 'XEAT';
            document.getElementById('supportEmail').value = appConfig.supportEmail || '';
            document.getElementById('heartbeatInterval').value = appData.devices?.templateDevice?.heartbeat?.intervalMs || 60000;
            document.getElementById('debugMode').checked = featureFlags.debugMode || false;
            document.getElementById('enableTelemetry').checked = featureFlags.telemetryCollection !== false;
        }
        
        // ==================== TELEMETRY ====================
        function updateTelemetryPage() {
            const stats = appData.statistics?.global || {};
            
            // Mettre a jour les compteurs
            document.getElementById('teleTotalSessions').textContent = stats.totalSessions || 0;
            document.getElementById('teleTotalUploads').textContent = stats.totalUploads || 0;
            document.getElementById('teleTotalModules').textContent = stats.totalModules || 0;
            document.getElementById('teleTotalErrors').textContent = stats.totalErrors || 0;
            
            // Mettre a jour l'utilisation par module
            const moduleUsage = appData.statistics?.byModule || {};
            const moduleContainer = document.getElementById('moduleUsage');
            
            if (Object.keys(moduleUsage).length === 0) {
                moduleContainer.innerHTML = '<p style="color: var(--xnrgy-text-muted);">Aucune donnee d\'utilisation disponible</p>';
                return;
            }
            
            let html = '<div class="module-usage-list">';
            for (const [moduleName, count] of Object.entries(moduleUsage)) {
                const displayName = moduleName.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').trim();
                html += `
                    <div class="module-usage-item" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--xnrgy-border-light);">
                        <span style="font-weight: 500;">${displayName}</span>
                        <span style="color: var(--xnrgy-cyan);">${count} utilisations</span>
                    </div>
                `;
            }
            html += '</div>';
            moduleContainer.innerHTML = html;
        }
        
        // ==================== AUDIT LOGS ====================
        function updateAuditPage() {
            const auditLogs = appData.auditLog || {};
            const tbody = document.getElementById('auditTable');
            
            // Convertir en array et trier par timestamp (plus recent en premier)
            const logsArray = Object.entries(auditLogs)
                .filter(([k, v]) => k !== 'placeholder' && v)
                .map(([id, log]) => ({ id, ...log }))
                .sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
            
            if (logsArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--xnrgy-text-muted);">Aucun log disponible</td></tr>';
                return;
            }
            
            // Afficher les 100 derniers logs
            const recentLogs = logsArray.slice(0, 100);
            
            tbody.innerHTML = recentLogs.map(log => {
                const actionColor = getActionColor(log.action, log.category);
                const icon = getActionIcon(log.action, log.category);
                
                return `
                    <tr>
                        <td style="white-space: nowrap;">${formatDate(log.timestamp)}</td>
                        <td>
                            <span style="display: inline-flex; align-items: center; gap: 6px;">
                                <span style="color: ${actionColor};">${icon}</span>
                                ${log.action || 'N/A'}
                            </span>
                        </td>
                        <td>${log.userName || log.userId || 'Systeme'}</td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(log.details || '')}">${log.details || '-'}</td>
                        <td>${log.ipAddress || 'local'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function getActionColor(action, category) {
            if (category === 'error' || action?.includes('error')) return 'var(--xnrgy-red)';
            if (category === 'session' || action?.includes('session')) return 'var(--xnrgy-green)';
            if (action?.includes('delete') || action?.includes('disable')) return 'var(--xnrgy-orange)';
            if (action?.includes('create') || action?.includes('add')) return 'var(--xnrgy-cyan)';
            return 'var(--xnrgy-text-secondary)';
        }
        
        function getActionIcon(action, category) {
            if (category === 'error' || action?.includes('error')) return '[-]';
            if (category === 'session') return '[>]';
            if (action?.includes('delete')) return '[x]';
            if (action?.includes('create') || action?.includes('add')) return '[+]';
            if (action?.includes('update') || action?.includes('modify')) return '[~]';
            return '[i]';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        function exportAuditLogs() {
            const auditLogs = appData.auditLog || {};
            
            // Convertir en array et trier
            const logsArray = Object.entries(auditLogs)
                .filter(([k, v]) => k !== 'placeholder' && v)
                .map(([id, log]) => ({ id, ...log }))
                .sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
            
            if (logsArray.length === 0) {
                showToast('Aucun log a exporter', 'warning');
                return;
            }
            
            // Creer le CSV
            const headers = ['Date/Heure', 'Action', 'Categorie', 'Utilisateur', 'Device', 'Details', 'IP', 'Succes'];
            const csvRows = [headers.join(';')];
            
            logsArray.forEach(log => {
                const row = [
                    log.timestamp || '',
                    log.action || '',
                    log.category || '',
                    log.userName || log.userId || '',
                    log.deviceId || '',
                    (log.details || '').replace(/;/g, ',').replace(/\n/g, ' '),
                    log.ipAddress || 'local',
                    log.success !== false ? 'Oui' : 'Non'
                ];
                csvRows.push(row.join(';'));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `xeat-audit-logs-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`${logsArray.length} logs exportes`, 'success');
        }
    </script>
</body>
</html>